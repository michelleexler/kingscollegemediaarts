<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Camera Equipment Loan System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            padding-top: 2rem;
            padding-bottom: 2rem;
            overflow-y: auto;
        }
        .modal-centered {
           align-items: center;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Equipment Loan System</h1>
            <p class="text-gray-600 mt-1">Manage and track all your camera equipment loans. (Shared)</p>
            <p id="userIdDisplay" class="text-xs text-gray-400 mt-2"></p>
        </header>

        <div class="space-y-8">
            <!-- Top Section: Create Loan and Available Items -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Column -->
                <div class="space-y-8">
                    <!-- Create New Loan Section -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 class="text-xl font-semibold mb-4">Create New Loan</h2>
                        <p class="text-sm text-gray-600 mb-4">Select available kits and enter a Unique Loan ID from your offline records.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="uniqueLoanId" class="block text-sm font-medium text-gray-700">Unique Loan ID</label>
                                <input type="text" id="uniqueLoanId" placeholder="e.g., LOAN-0708-A" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="loanDate" class="block text-sm font-medium text-gray-700">Loan Date</label>
                                    <input type="date" id="loanDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="dueDate" class="block text-sm font-medium text-gray-700">Due Date</label>
                                    <input type="date" id="dueDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </div>
                            </div>
                        </div>
                        <div class="mt-6">
                            <h3 class="text-md font-medium text-gray-800">Kits Selected:</h3>
                            <div id="selectedForLoanList" class="mt-2 text-sm text-gray-600 border rounded-lg p-3 min-h-[50px]">
                                <p>No kits selected.</p>
                            </div>
                        </div>
                        <div class="mt-6">
                            <button id="createLoanBtn" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out disabled:bg-gray-400" disabled>
                                Create Loan
                            </button>
                        </div>
                    </div>
                    <!-- Add New Kit Section -->
                    <div>
                        <button id="toggleAddFormBtn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300 flex justify-between items-center text-xl">
                            <span>Add New Kit</span>
                            <svg id="toggleIconAdd" class="w-6 h-6 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        <div id="addEquipmentContainer" class="hidden mt-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div class="space-y-4">
                                <div>
                                    <label for="kitName" class="block text-sm font-medium text-gray-700">Kit Name</label>
                                    <input type="text" id="kitName" placeholder="e.g., Canon Camera Kit 1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="kitCode" class="block text-sm font-medium text-gray-700">Kit Code / ID</label>
                                    <input type="text" id="kitCode" placeholder="e.g., CAM001" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="kitCategory" class="block text-sm font-medium text-gray-700">Category</label>
                                    <input type="text" id="kitCategory" placeholder="e.g., Camera, Tripod, Lighting" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                 <div>
                                    <label for="kitItems" class="block text-sm font-medium text-gray-700">Items in Kit (comma-separated)</label>
                                    <input type="text" id="kitItems" placeholder="e.g., Canon R5 Body, 50mm Lens, Battery" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                 </div>
                                <div>
                                    <label for="kitLocation" class="block text-sm font-medium text-gray-700">Storage Location</label>
                                    <input type="text" id="kitLocation" placeholder="e.g., Storeroom A, Shelf 3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <button id="addEquipmentBtn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                                    Add Kit
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Available Equipment Section -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Available Kits</h2>
                        <span id="bulkSelectCount" class="text-sm font-medium text-gray-500"></span>
                    </div>
                    <div class="mb-4">
                        <label for="categoryFilter" class="sr-only">Filter by category</label>
                        <select id="categoryFilter" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            <option selected>All Categories</option>
                        </select>
                    </div>
                    <div id="availableEquipmentList" class="space-y-3 h-[28rem] overflow-y-auto pr-2">
                        <p class="text-gray-500">Loading equipment...</p>
                    </div>
                    <div id="bulkActions" class="hidden mt-4 pt-4 border-t">
                        <button id="bulkMoveBtn" class="w-full bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700">
                            Bulk Move Selected Kits
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Currently On Loan Section -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h2 class="text-xl font-semibold mb-4">Currently On Loan</h2>
                <div id="onLoanList" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                     <p class="text-gray-500">Loading loans...</p>
                </div>
            </div>

            <!-- Collapsible Sections Wrapper -->
            <div class="space-y-4">
                <!-- START: General Item Inventory Section -->
                <div>
                    <button id="toggleGeneralItemsBtn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300 flex justify-between items-center text-xl">
                        <span>General Item Inventory</span>
                        <svg id="toggleIconGeneral" class="w-6 h-6 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div id="generalItemsWrapper" class="hidden mt-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div id="generalItemsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Add General Item Form -->
                            <div>
                                <h3 class="text-lg font-semibold mb-3">Add New Item</h3>
                                <div id="addGeneralItemForm" class="space-y-4">
                                    <div>
                                        <label for="generalItemName" class="block text-sm font-medium text-gray-700">Item Name</label>
                                        <input type="text" id="generalItemName" placeholder="e.g., 64GB SD Card" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    </div>
                                    <div>
                                        <label for="generalItemCategory" class="block text-sm font-medium text-gray-700">Category</label>
                                        <input type="text" id="generalItemCategory" placeholder="e.g., Storage, Power" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    </div>
                                    <div>
                                        <label for="generalItemQuantity" class="block text-sm font-medium text-gray-700">Quantity to Add</label>
                                        <input type="number" id="generalItemQuantity" value="1" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    </div>
                                    <div>
                                        <label for="generalItemLocation" class="block text-sm font-medium text-gray-700">Storage Location</label>
                                        <input type="text" id="generalItemLocation" placeholder="e.g., Cabinet C, Drawer 1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    </div>
                                    <button id="addGeneralItemBtn" class="w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700">Add Item(s)</button>
                                </div>
                            </div>
                            <!-- General Item List -->
                            <div>
                                <h3 class="text-lg font-semibold mb-3">Current Inventory</h3>
                                <div id="generalItemsList" class="space-y-3 h-72 overflow-y-auto pr-2">
                                    <p class="text-gray-500">Loading general items...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- END: General Item Inventory Section -->

                <!-- Under Maintenance Section -->
                <div>
                    <button id="toggleMaintenanceBtn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300 flex justify-between items-center text-xl">
                        <span class="text-orange-600">Under Maintenance</span>
                        <svg id="toggleIconMaint" class="w-6 h-6 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div id="maintenanceContainer" class="hidden mt-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div id="maintenanceList" class="space-y-3 h-48 overflow-y-auto pr-2">
                            <p class="text-gray-500">No items are under maintenance.</p>
                        </div>
                    </div>
                </div>
                <!-- Missing Equipment Section -->
                <div>
                    <button id="toggleMissingBtn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300 flex justify-between items-center text-xl">
                       <span class="text-red-600">Missing Equipment</span>
                       <svg id="toggleIconMiss" class="w-6 h-6 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div id="missingContainer" class="hidden mt-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div id="missingList" class="space-y-3 h-48 overflow-y-auto pr-2">
                            <p class="text-gray-500">No items are missing.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 bg-gray-800 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50"></div>

    <!-- Edit Loan Modal -->
    <div id="editLoanModal" class="modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl m-4 animate-fade-in">
            <h2 id="editLoanModalTitle" class="text-2xl font-bold mb-4">Edit Loan</h2>
            
            <div class="space-y-4">
                <div>
                    <h3 class="text-lg font-semibold mb-2">Items on this Loan</h3>
                    <div id="editLoanCurrentItems" class="space-y-2 max-h-48 overflow-y-auto pr-2 border rounded-md p-2"></div>
                </div>
                <div>
                    <label for="newDueDate" class="block text-sm font-medium text-gray-700">New Due Date</label>
                    <input type="date" id="newDueDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div class="pt-4 border-t">
                    <h3 class="text-lg font-semibold mb-2">Add Kits to Loan</h3>
                    <div id="editLoanAddableItems" class="space-y-2 max-h-48 overflow-y-auto pr-2 border rounded-md p-2"></div>
                </div>
                 <div>
                    <label for="editLoanNotes" class="block text-sm font-medium text-gray-700">Notes for this Update</label>
                    <textarea id="editLoanNotes" rows="2" class="w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., General notes about the loan update."></textarea>
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button id="editLoanCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="editLoanConfirmBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Confirm Changes</button>
            </div>
        </div>
    </div>
    
    <!-- History Modal -->
    <div id="historyModal" class="modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl m-4 animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                 <h2 id="historyModalTitle" class="text-2xl font-bold">Loan History</h2>
                 <button id="historyModalCloseBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="historyModalContent" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
            <div class="mt-6 pt-4 border-t border-gray-200">
                <button id="deleteItemBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 disabled:bg-gray-400">Delete This Kit Permanently</button>
            </div>
        </div>
    </div>

    <!-- Pre-Loan Checklist Modal -->
    <div id="preLoanChecklistModal" class="modal-backdrop modal-centered">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 animate-fade-in">
            <h2 id="preLoanChecklistTitle" class="text-2xl font-bold mb-4">Pre-Loan Checklist</h2>
            <form id="preLoanChecklistForm" class="space-y-3">
                 <div class="flex items-center justify-between">
                    <label class="text-sm font-medium">Condition good?</label>
                    <div>
                        <input type="radio" id="preLoanConditionYes" name="preLoanCondition" value="Yes" checked class="mr-1"><label for="preLoanConditionYes" class="mr-2 text-sm">Yes</label>
                        <input type="radio" id="preLoanConditionNo" name="preLoanCondition" value="No" class="mr-1"><label for="preLoanConditionNo" class="text-sm">No</label>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium">All accessories present?</label>
                    <div>
                        <input type="radio" id="preLoanAccessoriesYes" name="preLoanAccessories" value="Yes" checked class="mr-1"><label for="preLoanAccessoriesYes" class="mr-2 text-sm">Yes</label>
                        <input type="radio" id="preLoanAccessoriesNo" name="preLoanAccessories" value="No" class="mr-1"><label for="preLoanAccessoriesNo" class="text-sm">No</label>
                    </div>
                </div>
                <div>
                    <label for="preLoanNotes" class="block text-sm font-medium">Notes</label>
                    <textarea id="preLoanNotes" class="w-full p-2 border border-gray-300 rounded-md text-sm" rows="3" placeholder="e.g., Existing minor scratch on lens cap."></textarea>
                </div>
            </form>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="preLoanChecklistCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="preLoanChecklistConfirmBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Add to Loan</button>
            </div>
        </div>
    </div>


    <!-- Accessory Management Modal -->
    <div id="accessoryManagementModal" class="modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                 <h2 id="accessoryManagementTitle" class="text-2xl font-bold">Manage Kit Items</h2>
                 <button id="accessoryManagementCloseBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="accessoryManagementList" class="space-y-3"></div>
        </div>
    </div>

    <!-- Direct Maintenance/Missing Modal -->
    <div id="directActionModal" class="modal-backdrop modal-centered">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 animate-fade-in">
            <h2 id="directActionModalTitle" class="text-2xl font-bold mb-4"></h2>
            <div>
                <label for="directActionNotes" class="block text-sm font-medium text-gray-700 mb-1">Reason / Notes:</label>
                <textarea id="directActionNotes" rows="4" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="directActionCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="directActionConfirmBtn" class="text-white font-semibold py-2 px-4 rounded-lg"></button>
            </div>
        </div>
    </div>
    
    <!-- Maintenance Log Modal -->
    <div id="maintenanceModal" class="modal-backdrop modal-centered">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 animate-fade-in">
            <h2 id="maintenanceModalTitle" class="text-2xl font-bold mb-4">Log Maintenance</h2>
            <div>
                <label for="maintenanceNotes" class="block text-sm font-medium text-gray-700 mb-1">Action / Notes (e.g., Lens replaced, new strap attached)</label>
                <textarea id="maintenanceNotes" rows="4" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="maintenanceModalCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="maintenanceModalConfirmBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Complete Maintenance</button>
            </div>
        </div>
    </div>
    
    <!-- Mark as Found Modal -->
    <div id="foundModal" class="modal-backdrop modal-centered">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 animate-fade-in">
            <h2 id="foundModalTitle" class="text-2xl font-bold mb-4">Mark Item as Found</h2>
            <div>
                <label for="foundNotes" class="block text-sm font-medium text-gray-700 mb-1">Notes (e.g., Found in classroom 3C, replaced by John D.)</label>
                <textarea id="foundNotes" rows="4" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="foundModalCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="foundModalConfirmBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Mark as Found</button>
            </div>
        </div>
    </div>
        
    <!-- Bulk Move Modal -->
    <div id="bulkMoveModal" class="modal-backdrop modal-centered">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 animate-fade-in">
            <h2 id="bulkMoveModalTitle" class="text-2xl font-bold mb-4">Bulk Move Kits</h2>
            <div>
                <label for="bulkMoveLocation" class="block text-sm font-medium text-gray-700 mb-1">New Storage Location</label>
                <input type="text" id="bulkMoveLocation" placeholder="e.g., Cabinet B, Shelf 1" class="w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="bulkMoveCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="bulkMoveConfirmBtn" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700">Confirm Move</button>
            </div>
        </div>
    </div>

    <!-- Kit Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal-backdrop modal-centered">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 animate-fade-in">
            <h2 class="text-2xl font-bold mb-2 text-red-600">Confirm Deletion</h2>
            <p class="text-gray-600 mb-4">This action is permanent and cannot be undone. It will delete the kit and its entire loan history. To confirm, please type the kit's code below.</p>
            <p class="mb-2">Kit Code: <strong id="deleteConfirmCode" class="text-red-700"></strong></p>
            <input type="text" id="deleteConfirmInput" class="w-full p-2 border border-gray-300 rounded-md" autocomplete="off">
            <div class="flex justify-end space-x-3 mt-6">
                <button id="deleteConfirmCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="deleteConfirmFinalBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 disabled:bg-red-300" disabled>Delete Permanently</button>
            </div>
        </div>
    </div>

    <!-- General Item Delete Confirmation Modal -->
    <div id="generalItemDeleteConfirmModal" class="modal-backdrop modal-centered">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 animate-fade-in">
            <h2 class="text-2xl font-bold mb-2 text-red-600">Confirm Deletion</h2>
            <p id="generalItemDeleteConfirmText" class="text-gray-600 mb-4"></p>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="generalItemDeleteCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="generalItemDeleteConfirmBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">Delete Item</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, writeBatch, query, where, getDocs, updateDoc, deleteDoc, runTransaction, increment, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        document.addEventListener('DOMContentLoaded', () => {

            // --- App & Firebase State ---
            let db, auth, userId, isAuthReady = false;
            let selectedItems = new Map(); // For new loans
            let allEquipmentMasterList = [];
            let activeModal = { loan: null, kit: null, itemName: null, checklistData: null, kitsToAdd: null };
            
            // App-specific ID and Firebase configuration provided by the environment
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            // --- Firestore Collection Paths ---
            const getCollectionPath = (collectionName) => `artifacts/${appId}/public/data/${collectionName}`;
            const equipmentCollectionPath = getCollectionPath("equipment");
            const loansCollectionPath = getCollectionPath("loans");
            const historyCollectionPath = getCollectionPath("history");
            const generalItemsCollectionPath = getCollectionPath("general_items");
            
            // --- Toast Notification Utility ---
            function showToast(message, isError = false) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 z-50 ${isError ? 'bg-red-600' : 'bg-gray-800'}`;
                toast.classList.remove('opacity-0');
                setTimeout(() => { toast.classList.add('opacity-0'); }, 3000);
            }

            // --- Modal Management ---
            function openModal(modal) {
                modal.style.display = 'flex';
            }

            function closeModal(modal) {
                if(modal) modal.style.display = 'none';
                activeModal = { loan: null, kit: null, itemName: null, checklistData: null, kitsToAdd: null };
            }

            // --- Event Listener Setup ---
            function setupEventListeners() {
                document.getElementById('addEquipmentBtn').addEventListener('click', handleAddKit);
                document.getElementById('addGeneralItemBtn').addEventListener('click', handleAddGeneralItem);
                document.getElementById('createLoanBtn').addEventListener('click', confirmCreateLoan);
                document.getElementById('categoryFilter').addEventListener('change', renderAvailableKitList);
                
                document.getElementById('toggleGeneralItemsBtn').addEventListener('click', () => {
                    document.getElementById('generalItemsWrapper').classList.toggle('hidden');
                    document.getElementById('toggleIconGeneral').classList.toggle('rotate-180');
                });
                document.getElementById('toggleAddFormBtn').addEventListener('click', () => {
                    document.getElementById('addEquipmentContainer').classList.toggle('hidden');
                    document.getElementById('toggleIconAdd').classList.toggle('rotate-180');
                });
                document.getElementById('toggleMaintenanceBtn').addEventListener('click', () => {
                    document.getElementById('maintenanceContainer').classList.toggle('hidden');
                    document.getElementById('toggleIconMaint').classList.toggle('rotate-180');
                });
                document.getElementById('toggleMissingBtn').addEventListener('click', () => {
                    document.getElementById('missingContainer').classList.toggle('hidden');
                    document.getElementById('toggleIconMiss').classList.toggle('rotate-180');
                });
        
                document.querySelectorAll('.modal-backdrop').forEach(modal => {
                    const cancelBtn = modal.querySelector('[id$="CancelBtn"], [id$="CloseBtn"]');
                    if(cancelBtn) cancelBtn.addEventListener('click', () => closeModal(modal));
                });
        
                document.getElementById('maintenanceModalConfirmBtn').addEventListener('click', handleCompleteMaintenance);
                document.getElementById('foundModalConfirmBtn').addEventListener('click', handleMarkAsFound);
                document.getElementById('editLoanConfirmBtn').addEventListener('click', handleEditLoan);
                document.getElementById('preLoanChecklistConfirmBtn').addEventListener('click', handlePreLoanChecklistConfirm);
                document.getElementById('directActionConfirmBtn').addEventListener('click', handleDirectActionConfirm);
                document.getElementById('deleteConfirmFinalBtn').addEventListener('click', handleDeleteKitPermanently);
                document.getElementById('generalItemDeleteConfirmBtn').addEventListener('click', handleDeleteGeneralItem);
                document.getElementById('bulkMoveConfirmBtn').addEventListener('click', handleBulkMove);

                document.getElementById('deleteItemBtn').addEventListener('click', () => {
                    if (!activeModal.kit) return;
                    document.getElementById('deleteConfirmCode').textContent = activeModal.kit.code;
                    const confirmInput = document.getElementById('deleteConfirmInput');
                    const confirmBtn = document.getElementById('deleteConfirmFinalBtn');
                    confirmInput.value = '';
                    confirmBtn.disabled = true;
                    confirmInput.oninput = () => { confirmBtn.disabled = confirmInput.value !== activeModal.kit.code; };
                    openModal(document.getElementById('deleteConfirmModal'));
                });
                 
                document.getElementById('bulkMoveBtn').addEventListener('click', () => {
                    document.getElementById('bulkMoveModalTitle').textContent = `Bulk Move ${selectedItems.size} Kits`;
                    openModal(document.getElementById('bulkMoveModal'));
                });
            }
        
            // --- Initialization ---
            async function initialize() {
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    showToast("Firebase configuration is missing. App cannot start.", true);
                    console.error("CRITICAL: Firebase config is missing or invalid.");
                    return;
                }
                
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    setLogLevel('debug');

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            isAuthReady = true;
                            document.getElementById('userIdDisplay').textContent = `User ID: ${userId}`;
                            console.log("Firebase Auth state changed. User is signed in:", userId);
                            setupFirebaseListeners();
                        } else if (!isAuthReady) {
                            isAuthReady = true;
                            authenticate();
                        }
                    });

                    document.getElementById('loanDate').valueAsDate = new Date();
                    setupEventListeners();
                } catch (error) {
                    console.error("Initialization Error:", error);
                    showToast("Error connecting to the database.", true);
                }
            }

            async function authenticate() {
                try {
                    if (initialAuthToken) {
                        console.log("Signing in with custom token...");
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        console.log("No custom token found, signing in anonymously...");
                        await signInAnonymously(auth);
                    }
                } catch (e) {
                    console.error("Authentication failed:", e);
                    showToast("Authentication failed. The app may not work correctly.", true);
                }
            }
        
            // --- Firebase Listeners ---
            function setupFirebaseListeners() {
                if (!auth.currentUser) {
                    console.warn("setupFirebaseListeners called before user is authenticated.");
                    return;
                }
                onSnapshot(query(collection(db, equipmentCollectionPath)), snap => {
                    allEquipmentMasterList = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    allEquipmentMasterList.sort((a,b) => a.name.localeCompare(b.name));
                    populateCategoryFilter();
                    renderAllLists();
                }, (error) => console.error("Error listening to equipment collection:", error));
                
                onSnapshot(query(collection(db, loansCollectionPath)), snap => {
                    const loans = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderOnLoanList(loans);
                }, (error) => console.error("Error listening to loans collection:", error));

                onSnapshot(query(collection(db, generalItemsCollectionPath)), snap => {
                    const generalItems = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderGeneralItemsList(generalItems);
                }, (error) => console.error("Error listening to general items:", error));
            }
            
            // --- Dynamic Rendering Functions ---
            function populateCategoryFilter() {
                const categories = [...new Set(allEquipmentMasterList.map(item => item.category).filter(Boolean))];
                const currentSelection = categoryFilter.value;
                categoryFilter.innerHTML = '<option value="All Categories">All Categories</option>';
                categories.sort().forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categoryFilter.appendChild(option);
                });
                if (categories.includes(currentSelection)) {
                    categoryFilter.value = currentSelection;
                } else {
                    categoryFilter.value = 'All Categories';
                }
            }
    
            function renderAllLists() {
                renderAvailableKitList();
                renderMaintenanceList();
                renderMissingList();
            }
    
            function renderList(element, items, emptyText, itemRenderer) {
                element.innerHTML = '';
                if (items.length === 0) {
                    element.innerHTML = `<p class="text-gray-500 p-4">${emptyText}</p>`;
                } else {
                    items.forEach(item => itemRenderer(element, item));
                }
            }
    
            function renderAvailableKitList() {
                const selectedCategory = categoryFilter.value;
                const filteredKits = allEquipmentMasterList.filter(kit => 
                    kit.status === 'available' && 
                    (selectedCategory === 'All Categories' || kit.category === selectedCategory)
                );
        
                const availableListEl = document.getElementById('availableEquipmentList');
                renderList(availableListEl, filteredKits, 'No available kits in this category.', (el, kit) => {
                    const isSelected = selectedItems.has(kit.id);
                    const itemsNeedingAttention = (kit.items || []).some(i => i.status !== 'available');
                    
                    const div = document.createElement('div');
                    div.id = `available-kit-${kit.id}`;
                    div.className = `p-2 rounded-lg transition-colors ${isSelected ? 'bg-indigo-100' : 'hover:bg-gray-100'} ${itemsNeedingAttention ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`;
                    
                    const categoryTag = kit.category ? `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-200">${kit.category}</span>` : '';
                    const maintWarning = itemsNeedingAttention ? `<p class="text-xs font-semibold text-red-600">Unavailable (Maintenance Required)</p>` : '';

                    div.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center flex-grow pr-2">
                                <input type="checkbox" class="select-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-3" data-id="${kit.id}" ${isSelected ? 'checked' : ''} ${itemsNeedingAttention ? 'disabled' : ''}>
                                <div>
                                    <div class="flex items-center space-x-2">
                                        <p class="font-medium text-gray-800">${kit.name}</p>
                                        ${categoryTag}
                                    </div>
                                    <p class="text-xs text-gray-500">${kit.code}</p>
                                    <p class="text-xs text-gray-500 kit-location-text ${!itemsNeedingAttention ? 'cursor-pointer hover:text-indigo-600' : ''}" data-kit-id="${kit.id}">
                                        Location: ${kit.location || 'Not set'}
                                    </p>
                                    ${maintWarning}
                                </div>
                            </div>
                            <div class="flex flex-col space-y-1">
                                <button class="manage-btn text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold py-1 px-2 rounded-md">Manage</button>
                                <button class="history-btn text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-2 rounded-md">History</button>
                            </div>
                        </div>`;

                    if (!itemsNeedingAttention) {
                         const clickableArea = div.querySelector('.flex.items-center.flex-grow');
                         clickableArea.addEventListener('click', (e) => {
                             if (!e.target.closest('button, input[type="checkbox"], .kit-location-text')) {
                                 handleSelection(kit);
                             }
                         });
                         div.querySelector('.select-checkbox').addEventListener('click', (e) => {
                             e.stopPropagation();
                             handleSelection(kit);
                         });
                         div.querySelector('.kit-location-text').addEventListener('click', (e) => {
                             e.stopPropagation();
                             makeKitLocationEditable(e.target, kit.id, kit.location || '');
                         });
                    }

                    div.querySelector('.history-btn').addEventListener('click', (e) => { e.stopPropagation(); openHistoryModal(kit); });
                    div.querySelector('.manage-btn').addEventListener('click', (e) => { e.stopPropagation(); openKitManagementModal(kit); });
                    el.appendChild(div);
                });
                updateBulkActionsVisibility();
            }
            
            function renderSelectedForLoan() {
                document.getElementById('createLoanBtn').disabled = selectedItems.size === 0;
                const selectedListEl = document.getElementById('selectedForLoanList');
                renderList(selectedListEl, Array.from(selectedItems.values()), 'No kits selected.', (el, itemData) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex items-center justify-between bg-indigo-50 p-2 rounded-md mb-2';
                    itemDiv.innerHTML = `
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                            <span>${itemData.kit.name} (${itemData.kit.code}) - Checklist Complete</span>
                        </div>
                        <button data-id="${itemData.kit.id}" class="remove-selection-btn text-red-500 hover:text-red-700 font-bold">&times;</button>
                    `;
                    itemDiv.querySelector('.remove-selection-btn').addEventListener('click', (e) => {
                        const kitId = e.currentTarget.dataset.id;
                        selectedItems.delete(kitId);
                        renderSelectedForLoan();
                        renderAvailableKitList();
                    });
                    el.appendChild(itemDiv);
                });
            }

            function renderStatusList(elementId, status, emptyText, buttonText, buttonClass, onButtonClick) {
                const items = [];
                allEquipmentMasterList.forEach(kit => {
                    (kit.items || []).forEach(item => {
                        if (item.status === status) {
                            items.push({ ...kit, itemName: item.name, itemDetails: item });
                        }
                    });
                });

                const listEl = document.getElementById(elementId);
                renderList(listEl, items, emptyText, (el, item) => {
                    const div = document.createElement('div');
                    div.className = `p-2 rounded-lg ${status === 'missing' ? 'bg-red-50' : 'bg-orange-50'} flex items-center justify-between`;
                    const notes = item.itemDetails.notes ? `<p class="text-xs text-gray-500 mt-1">Notes: ${item.itemDetails.notes}</p>` : '';
                    div.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-800">${item.itemName} <span class="text-gray-500">from ${item.name}</span></p>
                            ${notes}
                        </div>
                        <button class="status-action-btn text-xs ${buttonClass} text-white font-semibold py-1 px-2 rounded-md">${buttonText}</button>
                    `;
                    div.querySelector('.status-action-btn').addEventListener('click', () => onButtonClick(item));
                    el.appendChild(div);
                });
            }

            function renderMaintenanceList() {
                renderStatusList('maintenanceList', 'under_maintenance', 'No items are under maintenance.', 'Log Maint.', 'bg-orange-500 hover:bg-orange-600', openMaintenanceModal);
            }

            function renderMissingList() {
                renderStatusList('missingList', 'missing', 'No items are missing.', 'Found', 'bg-red-500 hover:bg-red-600', openFoundModal);
            }

            function renderOnLoanList(loans) {
                loans.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)); // Sort by due date
                const onLoanListEl = document.getElementById('onLoanList');
                renderList(onLoanListEl, loans, 'No kits are currently on loan.', (el, loan) => {
                    const card = document.createElement('div');
                    const isOverdue = new Date(loan.dueDate) < new Date();
                    card.className = `bg-gray-50 p-4 rounded-lg border ${isOverdue ? 'border-red-400' : 'border-gray-200'} animate-fade-in`;
                    
                    const equipmentHtml = loan.kits.map(k => `<span class="inline-block bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 mr-2 mb-2">${k.name} (${k.code})</span>`).join('');
                    
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-lg">Loan ID: ${loan.loanId}</p>
                                ${isOverdue ? '<p class="text-red-600 font-bold text-sm">OVERDUE</p>' : ''}
                            </div>
                            <button data-loan-id="${loan.id}" class="manage-loan-btn bg-blue-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-blue-600 transition-colors text-sm">Manage Loan</button>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm"><span class="font-semibold">Loaned:</span> ${loan.loanDate}</p>
                            <p class="text-sm"><span class="font-semibold">Due:</span> ${loan.dueDate}</p>
                        </div>
                        <div class="mt-4 pt-4 border-t">
                            <h4 class="font-semibold mb-2">Kits:</h4>
                            <div class="flex flex-wrap">${equipmentHtml}</div>
                        </div>
                    `;
                    card.querySelector('.manage-loan-btn').addEventListener('click', (e) => {
                        const foundLoan = loans.find(l => l.id === e.target.dataset.loanId);
                        if (foundLoan) openEditLoanModal(foundLoan);
                    });
                    el.appendChild(card);
                });
            }

            function renderGeneralItemsList(items) {
                 items.sort((a,b) => a.name.localeCompare(b.name));
                 const listEl = document.getElementById('generalItemsList');
                 renderList(listEl, items, 'No general items in inventory.', (el, item) => {
                     const div = document.createElement('div');
                     div.className = 'p-3 rounded-lg bg-gray-50 border flex items-center justify-between';
                     div.innerHTML = `
                         <div>
                             <p class="font-medium text-gray-900">${item.name}</p>
                             <p class="text-xs text-gray-500">In Stock: <span class="font-bold text-lg">${item.quantity}</span></p>
                             <p class="text-xs text-gray-500">Category: ${item.category || 'N/A'}</p>
                             <p class="text-xs text-gray-500 general-item-location-text cursor-pointer hover:text-indigo-600" data-item-id="${item.id}">Location: ${item.location || 'N/A'}</p>
                         </div>
                         <div class="flex items-center space-x-2">
                             <button data-id="${item.id}" class="general-item-decrement text-white bg-red-500 hover:bg-red-600 rounded-full w-8 h-8 font-bold text-xl flex items-center justify-center">-</button>
                             <button data-id="${item.id}" class="general-item-increment text-white bg-green-500 hover:bg-green-600 rounded-full w-8 h-8 font-bold text-xl flex items-center justify-center">+</button>
                              <button data-item-id="${item.id}" data-item-name="${item.name}" class="general-item-delete text-gray-400 hover:text-red-500 font-bold text-2xl ml-2">&times;</button>
                         </div>
                     `;
                     el.appendChild(div);

                     div.querySelector('.general-item-increment').addEventListener('click', () => updateDoc(doc(db, generalItemsCollectionPath, item.id), { quantity: increment(1) }));
                     div.querySelector('.general-item-decrement').addEventListener('click', () => { if (item.quantity > 0) updateDoc(doc(db, generalItemsCollectionPath, item.id), { quantity: increment(-1) }); });
                     div.querySelector('.general-item-delete').addEventListener('click', (e) => {
                         const itemId = e.currentTarget.dataset.itemId;
                         const itemName = e.currentTarget.dataset.itemName;
                         activeModal.kit = { id: itemId, name: itemName };
                         document.getElementById('generalItemDeleteConfirmText').textContent = `Are you sure you want to delete all "${itemName}" items from the inventory? This action cannot be undone.`;
                         openModal(document.getElementById('generalItemDeleteConfirmModal'));
                     });
                     div.querySelector('.general-item-location-text').addEventListener('click', (e) => {
                         e.stopPropagation();
                         makeGeneralItemLocationEditable(e.currentTarget, item.id, item.location || '');
                     });
                 });
             }
             
            function updateBulkActionsVisibility() {
                const bulkSelectCount = document.getElementById('bulkSelectCount');
                const bulkActionsContainer = document.getElementById('bulkActions');
                const hasSelections = selectedItems.size > 0;

                bulkActionsContainer.classList.toggle('hidden', !hasSelections);
                bulkSelectCount.textContent = hasSelections ? `${selectedItems.size} selected` : '';
            }

            // --- Handlers for User Actions ---

            async function updateItemStatus(kit, newStatus, notes, itemName) {
                if (!kit || !kit.id || !itemName) return showToast('Invalid data for status update.', true);

                const kitDocRef = doc(db, equipmentCollectionPath, kit.id);
                const updatedItems = kit.items.map(item => {
                    if (item.name === itemName) {
                        return { ...item, status: newStatus, notes: notes || '' };
                    }
                    return item;
                });

                try {
                    const batch = writeBatch(db);
                    batch.update(kitDocRef, { items: updatedItems });

                    const historyNote = `Status of '${itemName}' changed to ${newStatus.replace(/_/g, ' ')}. Notes: ${notes}`;
                    batch.set(doc(collection(db, historyCollectionPath)), {
                        type: 'status_change',
                        kitId: kit.id,
                        kitName: kit.name,
                        notes: historyNote,
                        timestamp: serverTimestamp()
                    });
                    
                    await batch.commit();
                    showToast(`'${itemName}' status updated successfully.`);
                } catch (error) {
                    console.error('Error updating item status:', error);
                    showToast('Failed to update item status.', true);
                }
            }
            
            async function handleAddKit() {
                const name = document.getElementById('kitName').value.trim();
                const code = document.getElementById('kitCode').value.trim();
                let category = document.getElementById('kitCategory').value.trim();
                const itemsStr = document.getElementById('kitItems').value.trim();
                const location = document.getElementById('kitLocation').value.trim();
                if (!name || !code || !category) return showToast("Kit Name, Code, and Category are required.", true);
        
                if(category) {
                    category = category.charAt(0).toUpperCase() + category.slice(1);
                }
        
                const items = itemsStr ? itemsStr.split(',').map(s => ({ name: s.trim(), status: 'available', notes: '' })).filter(a => a.name) : [];
                try {
                    await addDoc(collection(db, equipmentCollectionPath), { name, code, category, items, status: 'available', location, createdAt: serverTimestamp() });
                    showToast("Kit added successfully!");
                    ['kitName', 'kitCode', 'kitCategory', 'kitItems', 'kitLocation'].forEach(id => document.getElementById(id).value = '');
                } catch (error) { 
                    console.error("Failed to add kit:", error);
                    showToast("Failed to add kit.", true); 
                }
            }

            function handleSelection(kit) {
                if (selectedItems.has(kit.id)) {
                    selectedItems.delete(kit.id);
                    renderAvailableKitList();
                    renderSelectedForLoan();
                } else {
                    openPreLoanChecklistModal(kit);
                }
            }

            function handlePreLoanChecklistConfirm() {
                 if (!activeModal.kit) return;
                 const kit = activeModal.kit;
                 const checklistData = {
                     conditionGood: document.querySelector('input[name="preLoanCondition"]:checked').value,
                     accessoriesPresent: document.querySelector('input[name="preLoanAccessories"]:checked').value,
                     notes: document.getElementById('preLoanNotes').value.trim()
                 };

                 selectedItems.set(kit.id, { kit, checklistData });
                 renderSelectedForLoan();
                 renderAvailableKitList();
                 closeModal(document.getElementById('preLoanChecklistModal'));
             }

            async function confirmCreateLoan() {
                const loanId = document.getElementById('uniqueLoanId').value.trim();
                const dueDate = document.getElementById('dueDate').value;
                const loanDate = document.getElementById('loanDate').value;
                if(!loanId || !dueDate) return showToast("Unique Loan ID and Due Date are required.", true);
                if (selectedItems.size === 0) return showToast("Please select at least one kit for the loan.", true);
                
                const kitsForLoan = Array.from(selectedItems.values()).map(item => ({
                    id: item.kit.id,
                    name: item.kit.name,
                    code: item.kit.code,
                    preLoanChecklist: item.checklistData
                }));

                try {
                    const batch = writeBatch(db);
                    const loanDocRef = doc(collection(db, loansCollectionPath));
                    batch.set(loanDocRef, {
                        loanId: loanId,
                        loanDate: loanDate,
                        dueDate: dueDate,
                        kits: kitsForLoan,
                        kitIds: kitsForLoan.map(e => e.id),
                        status: 'active',
                        createdAt: serverTimestamp()
                    });
                    
                    // Update status of each kit and create history records
                    kitsForLoan.forEach(kit => {
                        const kitDocRef = doc(db, equipmentCollectionPath, kit.id);
                        batch.update(kitDocRef, { status: 'on_loan' });

                        const historyDocRef = doc(collection(db, historyCollectionPath));
                        batch.set(historyDocRef, {
                            type: 'loan_created',
                            kitId: kit.id,
                            kitName: kit.name,
                            notes: `Added to new loan: ${loanId}. Due: ${dueDate}.`,
                            timestamp: serverTimestamp()
                        });
                    });
                    
                    await batch.commit();
                    
                    ['uniqueLoanId', 'dueDate'].forEach(id => document.getElementById(id).value = '');
                    document.getElementById('loanDate').valueAsDate = new Date();
                    selectedItems.clear();
                    renderSelectedForLoan();
                    renderAvailableKitList();
                    showToast("Loan created successfully!");
                } catch (error) { 
                    console.error("Failed to create loan:", error);
                    showToast("Failed to create loan.", true); 
                }
            }
            
            async function handleDirectActionConfirm(e) {
                const notes = document.getElementById('directActionNotes').value.trim();
                if (!notes) return showToast("Please provide a reason/notes.", true);
                if (!activeModal.kit || !activeModal.itemName) return showToast("An error occurred. No item selected.", true);
                
                const isMaint = e.target.textContent.toLowerCase().includes('maintenance');
                const newStatus = isMaint ? 'under_maintenance' : 'missing';

                await updateItemStatus(activeModal.kit, newStatus, notes, activeModal.itemName);
                closeModal(document.getElementById('directActionModal'));
                closeModal(document.getElementById('accessoryManagementModal'));
            }

            async function handleDeleteKitPermanently() {
                if (!activeModal.kit) return;
                const kit = activeModal.kit;
                try {
                    const batch = writeBatch(db);
                    batch.delete(doc(db, equipmentCollectionPath, kit.id));
                    
                    const q = query(collection(db, historyCollectionPath), where("kitId", "==", kit.id));
                    const historySnapshot = await getDocs(q);
                    historySnapshot.forEach(historyDoc => batch.delete(historyDoc.ref));
                    
                    await batch.commit();
                    showToast(`Successfully deleted ${kit.name} and all its history.`);
                    closeModal(document.getElementById('deleteConfirmModal'));
                    closeModal(document.getElementById('historyModal'));
                } catch(error) { 
                    console.error(`Failed to delete ${kit.name}:`, error);
                    showToast(`Failed to delete ${kit.name}.`, true); 
                }
            }
            
            async function handleDeleteGeneralItem() {
                 if (!activeModal.kit) return;
                 const { id, name } = activeModal.kit;

                 try {
                     await deleteDoc(doc(db, generalItemsCollectionPath, id));
                     showToast(`Deleted "${name}" from inventory.`);
                 } catch(error) {
                     console.error(`Error deleting general item "${name}":`, error);
                     showToast(`Failed to delete "${name}".`, true);
                 } finally {
                     closeModal(document.getElementById('generalItemDeleteConfirmModal'));
                 }
             }

            async function handleBulkMove() {
                 const newLocation = document.getElementById('bulkMoveLocation').value.trim();
                 if (!newLocation) return showToast("Please enter a new location.", true);
                 if (selectedItems.size === 0) return showToast("No items selected for bulk move.", true);

                 const batch = writeBatch(db);
                 const historyNote = `Bulk moved to "${newLocation}".`;

                 selectedItems.forEach((itemData, kitId) => {
                     const kitDocRef = doc(db, equipmentCollectionPath, kitId);
                     batch.update(kitDocRef, { location: newLocation });

                     const historyDocRef = doc(collection(db, historyCollectionPath));
                     batch.set(historyDocRef, {
                         type: 'location_change',
                         kitId: kitId,
                         kitName: itemData.kit.name,
                         notes: historyNote,
                         timestamp: serverTimestamp()
                     });
                 });

                 try {
                     await batch.commit();
                     showToast(`Successfully moved ${selectedItems.size} kits.`);
                     selectedItems.clear();
                     renderAvailableKitList();
                     closeModal(document.getElementById('bulkMoveModal'));
                 } catch (error) {
                     console.error("Bulk move failed:", error);
                     showToast("Bulk move failed. Please try again.", true);
                 }
             }
             
            async function handleCompleteMaintenance() {
                const notes = document.getElementById('maintenanceNotes').value.trim();
                if (!notes) return showToast('Please enter maintenance notes.', true);
                if (!activeModal.kit || !activeModal.itemName) return;

                await updateItemStatus(activeModal.kit, 'available', `Maintenance performed: ${notes}`, activeModal.itemName);
                closeModal(document.getElementById('maintenanceModal'));
            }

            async function handleMarkAsFound() {
                const notes = document.getElementById('foundNotes').value.trim();
                if (!notes) return showToast('Please enter notes about finding the item.', true);
                if (!activeModal.kit || !activeModal.itemName) return;

                await updateItemStatus(activeModal.kit, 'available', `Item found. Notes: ${notes}`, activeModal.itemName);
                closeModal(document.getElementById('foundModal'));
            }

            async function handleEditLoan() {
                if (!activeModal.loan) return showToast('No active loan to edit.', true);
                
                const loan = activeModal.loan;
                const loanDocRef = doc(db, loansCollectionPath, loan.id);
                const updateNotes = document.getElementById('editLoanNotes').value.trim();
                if (!updateNotes) return showToast("Please add notes for this loan update.", true);

                const newDueDate = document.getElementById('newDueDate').value;
                
                const returnActionSelects = document.querySelectorAll('.return-action-select');
                const kitsToReturn = new Map();
                returnActionSelects.forEach(select => {
                    if (select.value === 'return') {
                        const kitId = select.dataset.kitId;
                        const kit = loan.kits.find(k => k.id === kitId);
                        if (kit) kitsToReturn.set(kitId, kit);
                    }
                });

                const newKitsToAdd = activeModal.kitsToAdd ? Array.from(activeModal.kitsToAdd.values()) : [];
                const kitsToKeep = loan.kits.filter(k => !kitsToReturn.has(k.id));
                const finalKitsOnLoan = [...kitsToKeep, ...newKitsToAdd.map(k => ({id: k.id, name: k.name, code: k.code, preLoanChecklist: {}}))];
                
                const batch = writeBatch(db);

                // If all kits are returned, the loan is completed and deleted.
                if (finalKitsOnLoan.length === 0) {
                    batch.delete(loanDocRef);
                    kitsToReturn.forEach((kit, kitId) => {
                        batch.update(doc(db, equipmentCollectionPath, kitId), { status: 'available' });
                        batch.set(doc(collection(db, historyCollectionPath)), {
                            type: 'kit_returned',
                            kitId: kitId,
                            kitName: kit.name,
                            notes: `Returned from loan ${loan.loanId} as part of loan completion. Update Notes: ${updateNotes}`,
                            timestamp: serverTimestamp()
                        });
                    });

                    await batch.commit();
                    showToast(`Loan ${loan.loanId} completed.`);
                    closeModal(document.getElementById('editLoanModal'));
                    return;
                }

                // Otherwise, update the loan and log individual changes.
                // Log date change for kits that are remaining on the loan
                if (newDueDate !== loan.dueDate) {
                    finalKitsOnLoan.forEach(kit => {
                         batch.set(doc(collection(db, historyCollectionPath)), {
                            type: 'loan_updated',
                            kitId: kit.id,
                            kitName: kit.name,
                            notes: `Loan ${loan.loanId} due date changed from ${loan.dueDate} to ${newDueDate}. Update Notes: ${updateNotes}`,
                            timestamp: serverTimestamp()
                        });
                    });
                }

                // Log returned kits
                kitsToReturn.forEach((kit, kitId) => {
                    batch.update(doc(db, equipmentCollectionPath, kitId), { status: 'available' });
                    batch.set(doc(collection(db, historyCollectionPath)), {
                        type: 'kit_returned',
                        kitId: kitId,
                        kitName: kit.name,
                        notes: `Returned from loan ${loan.loanId}. Update Notes: ${updateNotes}`,
                        timestamp: serverTimestamp()
                    });
                });

                // Log added kits
                newKitsToAdd.forEach(kit => {
                    batch.update(doc(db, equipmentCollectionPath, kit.id), { status: 'on_loan' });
                     batch.set(doc(collection(db, historyCollectionPath)), {
                        type: 'kit_added_to_loan',
                        kitId: kit.id,
                        kitName: kit.name,
                        notes: `Added to existing loan ${loan.loanId}. Update Notes: ${updateNotes}`,
                        timestamp: serverTimestamp()
                    });
                });
                
                // Update the loan document
                batch.update(loanDocRef, {
                    dueDate: newDueDate,
                    kits: finalKitsOnLoan,
                    kitIds: finalKitsOnLoan.map(k => k.id)
                });

                await batch.commit();
                showToast(`Loan ${loan.loanId} updated.`);
                closeModal(document.getElementById('editLoanModal'));
            }
            
            async function handleAddGeneralItem() {
                const name = document.getElementById('generalItemName').value.trim();
                const category = document.getElementById('generalItemCategory').value.trim();
                const quantity = parseInt(document.getElementById('generalItemQuantity').value, 10);
                const location = document.getElementById('generalItemLocation').value.trim();

                if (!name || !category || !quantity || quantity < 1) {
                    return showToast("Name, Category, and a valid Quantity are required.", true);
                }

                try {
                    const q = query(collection(db, generalItemsCollectionPath), where("name", "==", name), where("category", "==", category));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        const existingDoc = querySnapshot.docs[0];
                        await updateDoc(doc(db, generalItemsCollectionPath, existingDoc.id), { quantity: increment(quantity) });
                        showToast(`Added ${quantity} to ${name} inventory.`);
                    } else {
                        await addDoc(collection(db, generalItemsCollectionPath), { name, category, quantity, location });
                        showToast(`Added new item: ${name}.`);
                    }

                    document.getElementById('addGeneralItemForm').reset();
                } catch (error) {
                    console.error("Error adding general item:", error);
                    showToast("Failed to add general item.", true);
                }
            }


            // --- Modal Opening Functions ---
            function openPreLoanChecklistModal(kit) {
                activeModal.kit = kit;
                document.getElementById('preLoanChecklistTitle').textContent = `Pre-Loan Checklist: ${kit.name}`;
                document.getElementById('preLoanChecklistForm').reset();
                openModal(document.getElementById('preLoanChecklistModal'));
            }

            function openMaintenanceModal(item) {
                activeModal.kit = item;
                activeModal.itemName = item.itemName;
                document.getElementById('maintenanceModalTitle').textContent = `Log Maintenance for ${item.itemName}`;
                document.getElementById('maintenanceNotes').value = '';
                openModal(document.getElementById('maintenanceModal'));
            }

            function openFoundModal(item) {
                activeModal.kit = item;
                activeModal.itemName = item.itemName;
                document.getElementById('foundModalTitle').textContent = `Mark as Found: ${item.itemName}`;
                document.getElementById('foundNotes').value = '';
                openModal(document.getElementById('foundModal'));
            }
            
            function openEditLoanModal(loan) {
                activeModal.loan = loan;
                const modal = document.getElementById('editLoanModal');
                document.getElementById('editLoanModalTitle').textContent = `Edit Loan: ${loan.loanId}`;
                document.getElementById('newDueDate').value = loan.dueDate;
                document.getElementById('editLoanNotes').value = '';
                activeModal.kitsToAdd = new Map(); // Reset on open

                const currentItemsContainer = document.getElementById('editLoanCurrentItems');
                currentItemsContainer.innerHTML = '';
                loan.kits.forEach(kit => {
                    const itemWrapper = document.createElement('div');
                    itemWrapper.id = `wrapper-${kit.id}`;
                    itemWrapper.className = 'p-2 bg-gray-100 rounded-md';

                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex items-center justify-between';
                    itemDiv.innerHTML = `
                        <span>${kit.name} (${kit.code})</span>
                        <select class="return-action-select text-sm rounded-md border-gray-300" data-kit-id="${kit.id}">
                            <option value="keep">Keep on Loan</option>
                            <option value="return">Return Kit</option>
                        </select>
                    `;
                    itemWrapper.appendChild(itemDiv);
                    currentItemsContainer.appendChild(itemWrapper);
                });

                const addableItemsContainer = document.getElementById('editLoanAddableItems');
                const loanKitIds = new Set(loan.kitIds);
                const addableKits = allEquipmentMasterList.filter(kit => kit.status === 'available' && !loanKitIds.has(kit.id));
                
                renderList(addableItemsContainer, addableKits, 'No other kits available to add.', (el, kit) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-2 hover:bg-gray-100 rounded-md';
                    div.innerHTML = `
                        <span>${kit.name} (${kit.code})</span>
                        <button class="add-to-loan-btn text-xs bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-2 rounded-md" data-kit-id="${kit.id}">Add</button>
                    `;
                    div.querySelector('.add-to-loan-btn').addEventListener('click', (e) => {
                        e.target.textContent = 'Added';
                        e.target.disabled = true;
                        const kitToAdd = allEquipmentMasterList.find(k => k.id === e.target.dataset.kitId);
                        activeModal.kitsToAdd.set(kitToAdd.id, kitToAdd);
                    });
                    el.appendChild(div);
                });

                openModal(modal);
            }

            function openKitManagementModal(kit) {
                activeModal.kit = kit;
                const modal = document.getElementById('accessoryManagementModal');
                const titleEl = document.getElementById('accessoryManagementTitle');
                const listEl = document.getElementById('accessoryManagementList');
                
                titleEl.textContent = `Manage Items for ${kit.name}`;
                listEl.innerHTML = '';

                if (!kit.items || kit.items.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500">This kit has no individual items listed.</p>';
                    openModal(modal);
                    return;
                }

                kit.items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'p-3 bg-gray-50 rounded-md border flex items-center justify-between';
                    
                    let statusBadge = '';
                    if (item.status === 'missing') {
                        statusBadge = '<span class="text-xs font-semibold text-red-600">Missing</span>';
                    } else if (item.status === 'under_maintenance') {
                        statusBadge = '<span class="text-xs font-semibold text-orange-600">Maintenance</span>';
                    }

                    div.innerHTML = `
                        <div>
                            <p class="font-medium">${item.name} ${statusBadge}</p>
                            ${item.notes ? `<p class="text-xs text-gray-500">Notes: ${item.notes}</p>` : ''}
                        </div>
                        <div class="flex space-x-2">
                            <button data-item-name="${item.name}" class="maint-btn text-xs bg-orange-100 hover:bg-orange-200 text-orange-700 font-semibold py-1 px-2 rounded-md">Maint.</button>
                            <button data-item-name="${item.name}" class="miss-btn text-xs bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-1 px-2 rounded-md">Missing</button>
                        </div>
                    `;

                    div.querySelector('.maint-btn').addEventListener('click', (e) => {
                        const itemName = e.target.dataset.itemName;
                        activeModal.itemName = itemName;
                        const directActionModal = document.getElementById('directActionModal');
                        document.getElementById('directActionModalTitle').textContent = `Set "${itemName}" to Maintenance`;
                        document.getElementById('directActionNotes').value = '';
                        const confirmBtn = document.getElementById('directActionConfirmBtn');
                        confirmBtn.textContent = 'Set to Maintenance';
                        confirmBtn.className = 'bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-700';
                        openModal(directActionModal);
                    });
                    
                    div.querySelector('.miss-btn').addEventListener('click', (e) => {
                        const itemName = e.target.dataset.itemName;
                        activeModal.itemName = itemName;
                        const directActionModal = document.getElementById('directActionModal');
                        document.getElementById('directActionModalTitle').textContent = `Mark "${itemName}" as Missing`;
                        document.getElementById('directActionNotes').value = '';
                        const confirmBtn = document.getElementById('directActionConfirmBtn');
                        confirmBtn.textContent = 'Mark as Missing';
                        confirmBtn.className = 'bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700';
                        openModal(directActionModal);
                    });
                    listEl.appendChild(div);
                });
                openModal(modal);
            }

            async function openHistoryModal(kit) {
                 activeModal.kit = kit;
                 const historyModal = document.getElementById('historyModal');
                 const titleEl = document.getElementById('historyModalTitle');
                 const contentEl = document.getElementById('historyModalContent');
                 const deleteBtn = document.getElementById('deleteItemBtn');

                 titleEl.textContent = `History for ${kit.name} (${kit.code})`;
                 contentEl.innerHTML = '<p class="text-gray-500">Loading history...</p>';
                 deleteBtn.disabled = kit.status !== 'available';

                 openModal(historyModal);

                 try {
                     const q = query(collection(db, historyCollectionPath), where("kitId", "==", kit.id));
                     const snap = await getDocs(q);
                     const historyItems = snap.docs.map(d => d.data());
                     historyItems.sort((a,b) => b.timestamp.toMillis() - a.timestamp.toMillis());

                     contentEl.innerHTML = '';
                     if (historyItems.length === 0) {
                         contentEl.innerHTML = '<p class="text-gray-500">No history found for this kit.</p>';
                         return;
                     }
                     
                     historyItems.forEach(item => {
                         const div = document.createElement('div');
                         div.className = 'p-3 bg-gray-50 rounded-md border';
                         const date = item.timestamp ? item.timestamp.toDate().toLocaleString() : 'Date not available';
                         div.innerHTML = `
                             <p class="font-semibold">${item.type ? item.type.replace(/_/g, ' ').toUpperCase() : 'EVENT'}</p>
                             <p class="text-sm text-gray-700">${item.notes}</p>
                             <p class="text-xs text-gray-500 mt-1">${date}</p>
                         `;
                         contentEl.appendChild(div);
                     });

                 } catch(error) {
                     console.error("Error fetching history:", error);
                     contentEl.innerHTML = '<p class="text-red-500">Could not load history.</p>';
                 }
             }

            async function makeKitLocationEditable(pElement, kitId, currentLocation) {
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentLocation;
                input.className = 'w-full text-xs p-1 border border-indigo-300 rounded-md';
                pElement.replaceWith(input);
                input.focus();

                const saveLocation = async () => {
                    const newLocation = input.value.trim();
                    if (newLocation === currentLocation) {
                         renderAvailableKitList();
                         return;
                    }
                    try {
                        await updateDoc(doc(db, equipmentCollectionPath, kitId), { location: newLocation });
                        showToast("Kit location updated.");
                    } catch (error) {
                        showToast("Failed to update kit location.", true);
                    }
                };

                input.addEventListener('blur', saveLocation);
                input.addEventListener('keydown', (e) => { if (e.key === 'Enter') input.blur(); });
            }

            async function makeGeneralItemLocationEditable(pElement, itemId, currentLocation) {
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentLocation;
                input.className = 'w-full text-xs p-1 border border-indigo-300 rounded-md';
                pElement.replaceWith(input);
                input.focus();

                const saveLocation = async () => {
                    const newLocation = input.value.trim();
                    if (newLocation === currentLocation) {
                        const newP = document.createElement('p');
                        newP.className = pElement.className;
                        newP.textContent = `Location: ${currentLocation || 'N/A'}`;
                        input.replaceWith(newP);
                        // Re-add listener
                        newP.addEventListener('click', (e) => {
                            e.stopPropagation();
                            makeGeneralItemLocationEditable(e.currentTarget, itemId, currentLocation);
                        });
                        return;
                    }
                    
                    try {
                        await updateDoc(doc(db, generalItemsCollectionPath, itemId), { location: newLocation });
                        showToast("Item location updated.");
                        // The onSnapshot listener will handle re-rendering
                    } catch (error) {
                        showToast("Failed to update location.", true);
                        // Revert on failure
                        const newP = document.createElement('p');
                        newP.className = pElement.className;
                        newP.textContent = `Location: ${currentLocation || 'N/A'}`;
                        input.replaceWith(newP);
                    }
                };

                input.addEventListener('blur', saveLocation);
                input.addEventListener('keydown', (e) => { if (e.key === 'Enter') input.blur(); });
            }


            // --- Start the application ---
            initialize();
        });
    </script>
</body>
</html>
