<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Camera Equipment Loan System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            padding-top: 2rem;
            padding-bottom: 2rem;
            overflow-y: auto;
        }
        .modal-centered {
           align-items: center;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Equipment Loan System</h1>
            <p class="text-gray-600 mt-1">Manage and track all your camera equipment loans. (Shared)</p>
        </header>

        <div class="space-y-8">
            <!-- Top Section: Create Loan and Available Items -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Column -->
                <div class="space-y-8">
                    <!-- Create New Loan Section -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 class="text-xl font-semibold mb-4">Create New Loan</h2>
                        <p class="text-sm text-gray-600 mb-4">Select available kits and enter a Unique Loan ID from your offline records.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="uniqueLoanId" class="block text-sm font-medium text-gray-700">Unique Loan ID</label>
                                <input type="text" id="uniqueLoanId" placeholder="e.g., LOAN-0708-A" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="loanDate" class="block text-sm font-medium text-gray-700">Loan Date</label>
                                    <input type="date" id="loanDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="dueDate" class="block text-sm font-medium text-gray-700">Due Date</label>
                                    <input type="date" id="dueDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </div>
                            </div>
                        </div>
                        <div class="mt-6">
                            <h3 class="text-md font-medium text-gray-800">Kits Selected:</h3>
                            <div id="selectedForLoanList" class="mt-2 text-sm text-gray-600 border rounded-lg p-3 min-h-[50px]">
                                <p>No kits selected.</p>
                            </div>
                        </div>
                        <div class="mt-6">
                            <button id="createLoanBtn" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out disabled:bg-gray-400" disabled>
                                Create Loan
                            </button>
                        </div>
                    </div>
                    <!-- Add New Kit Section -->
                    <div>
                        <button id="toggleAddFormBtn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300 flex justify-between items-center text-xl">
                            <span>Add New Kit</span>
                            <svg id="toggleIconAdd" class="w-6 h-6 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        <div id="addEquipmentContainer" class="hidden mt-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div class="space-y-4">
                                <div>
                                    <label for="kitName" class="block text-sm font-medium text-gray-700">Kit Name</label>
                                    <input type="text" id="kitName" placeholder="e.g., Canon Camera Kit 1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="kitCode" class="block text-sm font-medium text-gray-700">Kit Code / ID</label>
                                    <input type="text" id="kitCode" placeholder="e.g., CAM001" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="kitCategory" class="block text-sm font-medium text-gray-700">Category</label>
                                    <input type="text" id="kitCategory" placeholder="e.g., Camera, Tripod, Lighting" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                 <div>
                                    <label for="kitItems" class="block text-sm font-medium text-gray-700">Items in Kit (comma-separated)</label>
                                    <input type="text" id="kitItems" placeholder="e.g., Canon R5 Body, 50mm Lens, Battery" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="kitLocation" class="block text-sm font-medium text-gray-700">Storage Location</label>
                                    <input type="text" id="kitLocation" placeholder="e.g., Storeroom A, Shelf 3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <button id="addEquipmentBtn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                                    Add Kit
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Available Equipment Section -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Available Kits</h2>
                        <span id="bulkSelectCount" class="text-sm font-medium text-gray-500"></span>
                    </div>
                    <div class="mb-4">
                        <label for="categoryFilter" class="sr-only">Filter by category</label>
                        <select id="categoryFilter" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            <option selected>All Categories</option>
                        </select>
                    </div>
                    <div id="availableEquipmentList" class="space-y-3 h-[28rem] overflow-y-auto pr-2">
                        <p class="text-gray-500">Loading equipment...</p>
                    </div>
                    <div id="bulkActions" class="hidden mt-4 pt-4 border-t">
                        <button id="bulkMoveBtn" class="w-full bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700">
                            Bulk Move Selected Kits
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Currently On Loan Section -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h2 class="text-xl font-semibold mb-4">Currently On Loan</h2>
                <div id="onLoanList" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                     <p class="text-gray-500">Loading loans...</p>
                </div>
            </div>

            <!-- Collapsible Sections Wrapper -->
            <div class="space-y-4">
                <!-- START: General Item Inventory Section -->
                <div>
                    <button id="toggleGeneralItemsBtn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300 flex justify-between items-center text-xl">
                        <span>General Item Inventory</span>
                        <svg id="toggleIconGeneral" class="w-6 h-6 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div id="generalItemsWrapper" class="hidden mt-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div id="generalItemsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Add General Item Form -->
                            <div>
                                <h3 class="text-lg font-semibold mb-3">Add New Item</h3>
                                <div id="addGeneralItemForm" class="space-y-4">
                                    <div>
                                        <label for="generalItemName" class="block text-sm font-medium text-gray-700">Item Name</label>
                                        <input type="text" id="generalItemName" placeholder="e.g., 64GB SD Card" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    </div>
                                    <div>
                                        <label for="generalItemCategory" class="block text-sm font-medium text-gray-700">Category</label>
                                        <input type="text" id="generalItemCategory" placeholder="e.g., Storage, Power" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    </div>
                                    <div>
                                        <label for="generalItemQuantity" class="block text-sm font-medium text-gray-700">Quantity to Add</label>
                                        <input type="number" id="generalItemQuantity" value="1" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    </div>
                                    <div>
                                        <label for="generalItemLocation" class="block text-sm font-medium text-gray-700">Storage Location</label>
                                        <input type="text" id="generalItemLocation" placeholder="e.g., Cabinet C, Drawer 1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    </div>
                                    <button id="addGeneralItemBtn" class="w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700">Add Item(s)</button>
                                </div>
                            </div>
                            <!-- General Item List -->
                            <div>
                                <h3 class="text-lg font-semibold mb-3">Current Inventory</h3>
                                <div id="generalItemsList" class="space-y-3 h-72 overflow-y-auto pr-2">
                                    <p class="text-gray-500">Loading general items...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- END: General Item Inventory Section -->

                <!-- Under Maintenance Section -->
                <div>
                    <button id="toggleMaintenanceBtn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300 flex justify-between items-center text-xl">
                        <span class="text-orange-600">Under Maintenance</span>
                        <svg id="toggleIconMaint" class="w-6 h-6 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div id="maintenanceContainer" class="hidden mt-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div id="maintenanceList" class="space-y-3 h-48 overflow-y-auto pr-2">
                            <p class="text-gray-500">No items are under maintenance.</p>
                        </div>
                    </div>
                </div>
                <!-- Missing Equipment Section -->
                <div>
                    <button id="toggleMissingBtn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300 flex justify-between items-center text-xl">
                       <span class="text-red-600">Missing Equipment</span>
                       <svg id="toggleIconMiss" class="w-6 h-6 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div id="missingContainer" class="hidden mt-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div id="missingList" class="space-y-3 h-48 overflow-y-auto pr-2">
                            <p class="text-gray-500">No items are missing.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 bg-gray-800 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50"></div>

    <!-- Edit Loan Modal -->
    <div id="editLoanModal" class="modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl m-4 animate-fade-in">
            <h2 id="editLoanModalTitle" class="text-2xl font-bold mb-4">Edit Loan</h2>
            
            <div class="space-y-4">
                <div>
                    <h3 class="text-lg font-semibold mb-2">Items on this Loan</h3>
                    <div id="editLoanCurrentItems" class="space-y-2 max-h-48 overflow-y-auto pr-2 border rounded-md p-2"></div>
                </div>

                <div class="pt-4 border-t">
                    <h3 class="text-lg font-semibold mb-2">Add Kits to Loan</h3>
                    <div id="editLoanAddableItems" class="space-y-2 max-h-48 overflow-y-auto pr-2 border rounded-md p-2"></div>
                </div>
                 <div>
                    <label for="editLoanNotes" class="block text-sm font-medium text-gray-700">Notes for this Update</label>
                    <textarea id="editLoanNotes" rows="2" class="w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., General notes about the loan update."></textarea>
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button id="editLoanCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="editLoanConfirmBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Confirm Changes</button>
            </div>
        </div>
    </div>
    
    <!-- History Modal -->
    <div id="historyModal" class="modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl m-4 animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                 <h2 id="historyModalTitle" class="text-2xl font-bold">Loan History</h2>
                 <button id="historyModalCloseBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="historyModalContent" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
            <div class="mt-6 pt-4 border-t border-gray-200">
                <button id="deleteItemBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 disabled:bg-gray-400">Delete This Kit Permanently</button>
            </div>
        </div>
    </div>

    <!-- Pre-Loan Checklist Modal -->
    <div id="preLoanChecklistModal" class="modal-backdrop modal-centered">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 animate-fade-in">
            <h2 id="preLoanChecklistTitle" class="text-2xl font-bold mb-4">Pre-Loan Checklist</h2>
            <form id="preLoanChecklistForm" class="space-y-3">
                 <div class="flex items-center justify-between">
                    <label class="text-sm font-medium">Condition good?</label>
                    <div>
                        <input type="radio" id="preLoanConditionYes" name="preLoanCondition" value="Yes" checked class="mr-1"><label for="preLoanConditionYes" class="mr-2 text-sm">Yes</label>
                        <input type="radio" id="preLoanConditionNo" name="preLoanCondition" value="No" class="mr-1"><label for="preLoanConditionNo" class="text-sm">No</label>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium">All accessories present?</label>
                    <div>
                        <input type="radio" id="preLoanAccessoriesYes" name="preLoanAccessories" value="Yes" checked class="mr-1"><label for="preLoanAccessoriesYes" class="mr-2 text-sm">Yes</label>
                        <input type="radio" id="preLoanAccessoriesNo" name="preLoanAccessories" value="No" class="mr-1"><label for="preLoanAccessoriesNo" class="text-sm">No</label>
                    </div>
                </div>
                <div>
                    <label for="preLoanNotes" class="block text-sm font-medium">Notes</label>
                    <textarea id="preLoanNotes" class="w-full p-2 border border-gray-300 rounded-md text-sm" rows="3" placeholder="e.g., Existing minor scratch on lens cap."></textarea>
                </div>
            </form>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="preLoanChecklistCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="preLoanChecklistConfirmBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Add to Loan</button>
            </div>
        </div>
    </div>


    <!-- Accessory Management Modal -->
    <div id="accessoryManagementModal" class="modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                 <h2 id="accessoryManagementTitle" class="text-2xl font-bold">Manage Kit Items</h2>
                 <button id="accessoryManagementCloseBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="accessoryManagementList" class="space-y-3"></div>
        </div>
    </div>

    <!-- Direct Maintenance/Missing Modal -->
    <div id="directActionModal" class="modal-backdrop modal-centered">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 animate-fade-in">
            <h2 id="directActionModalTitle" class="text-2xl font-bold mb-4"></h2>
            <div>
                <label for="directActionNotes" class="block text-sm font-medium text-gray-700 mb-1">Reason / Notes:</label>
                <textarea id="directActionNotes" rows="4" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="directActionCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="directActionConfirmBtn" class="text-white font-semibold py-2 px-4 rounded-lg"></button>
            </div>
        </div>
    </div>
    
    <!-- Maintenance Log Modal -->
    <div id="maintenanceModal" class="modal-backdrop modal-centered">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 animate-fade-in">
            <h2 id="maintenanceModalTitle" class="text-2xl font-bold mb-4">Log Maintenance</h2>
            <div>
                <label for="maintenanceNotes" class="block text-sm font-medium text-gray-700 mb-1">Action / Notes (e.g., Lens replaced, new strap attached)</label>
                <textarea id="maintenanceNotes" rows="4" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="maintenanceModalCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="maintenanceModalConfirmBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Complete Maintenance</button>
            </div>
        </div>
    </div>
    
    <!-- Mark as Found Modal -->
    <div id="foundModal" class="modal-backdrop modal-centered">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 animate-fade-in">
            <h2 id="foundModalTitle" class="text-2xl font-bold mb-4">Mark Item as Found</h2>
            <div>
                <label for="foundNotes" class="block text-sm font-medium text-gray-700 mb-1">Notes (e.g., Found in classroom 3C, replaced by John D.)</label>
                <textarea id="foundNotes" rows="4" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="foundModalCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="foundModalConfirmBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Mark as Found</button>
            </div>
        </div>
    </div>
        
    <!-- Bulk Move Modal -->
    <div id="bulkMoveModal" class="modal-backdrop modal-centered">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 animate-fade-in">
            <h2 id="bulkMoveModalTitle" class="text-2xl font-bold mb-4">Bulk Move Kits</h2>
            <div>
                <label for="bulkMoveLocation" class="block text-sm font-medium text-gray-700 mb-1">New Storage Location</label>
                <input type="text" id="bulkMoveLocation" placeholder="e.g., Cabinet B, Shelf 1" class="w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="bulkMoveCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="bulkMoveConfirmBtn" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700">Confirm Move</button>
            </div>
        </div>
    </div>

    <!-- Kit Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal-backdrop modal-centered">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 animate-fade-in">
            <h2 class="text-2xl font-bold mb-2 text-red-600">Confirm Deletion</h2>
            <p class="text-gray-600 mb-4">This action is permanent and cannot be undone. It will delete the kit and its entire loan history. To confirm, please type the kit's code below.</p>
            <p class="mb-2">Kit Code: <strong id="deleteConfirmCode" class="text-red-700"></strong></p>
            <input type="text" id="deleteConfirmInput" class="w-full p-2 border border-gray-300 rounded-md" autocomplete="off">
            <div class="flex justify-end space-x-3 mt-6">
                <button id="deleteConfirmCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="deleteConfirmFinalBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 disabled:bg-red-300" disabled>Delete Permanently</button>
            </div>
        </div>
    </div>

    <!-- General Item Delete Confirmation Modal -->
    <div id="generalItemDeleteConfirmModal" class="modal-backdrop modal-centered">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 animate-fade-in">
            <h2 class="text-2xl font-bold mb-2 text-red-600">Confirm Deletion</h2>
            <p id="generalItemDeleteConfirmText" class="text-gray-600 mb-4"></p>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="generalItemDeleteCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="generalItemDeleteConfirmBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">Delete Item</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, writeBatch, query, where, getDocs, updateDoc, deleteDoc, runTransaction, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        document.addEventListener('DOMContentLoaded', () => {
            // --- Firebase Configuration ---
const firebaseConfig = {
  apiKey: "AIzaSyC5TJD1OHfDRaH8449-rTViuc1ihaPsUK0",
  authDomain: "camera-equipment-hire-pma.firebaseapp.com",
  projectId: "camera-equipment-hire-pma",
  storageBucket: "camera-equipment-hire-pma.firebasestorage.app",
  messagingSenderId: "263891339773",
  appId: "1:263891339773:web:1b69db44cd3f683fdd3194",
  measurementId: "G-X766QG03D3"
};

const app = initializeApp(firebaseConfig);

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'camera-loan-system-shared';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            // --- End of Configuration ---
});
</script>
            let db, auth;
            let selectedItems = new Map();
            let allEquipmentMasterList = [];
            let activeModal = { loan: null, kit: null, itemName: null, checklistData: null };
            
            // --- DOM Elements ---
            const addEquipmentBtn = document.getElementById('addEquipmentBtn');
            const createLoanBtn = document.getElementById('createLoanBtn');
            const availableEquipmentList = document.getElementById('availableEquipmentList');
            const maintenanceList = document.getElementById('maintenanceList');
            const missingList = document.getElementById('missingList');
            const onLoanList = document.getElementById('onLoanList');
            const selectedForLoanList = document.getElementById('selectedForLoanList');
            const categoryFilter = document.getElementById('categoryFilter');
            const allModals = document.querySelectorAll('.modal-backdrop');
            
            // Firestore Paths
            const equipmentCollectionPath = `artifacts/${appId}/public/data/equipment`;
            const loansCollectionPath = `artifacts/${appId}/public/data/loans`;
            const historyCollectionPath = `artifacts/${appId}/public/data/loan_history`;
            const generalItemsCollectionPath = `artifacts/${appId}/public/data/general_items`;
            const equipmentDocPath = (id) => `artifacts/${appId}/public/data/equipment/${id}`;
            const loanDocPath = (id) => `artifacts/${appId}/public/data/loans/${id}`;
            const generalItemDocPath = (id) => `artifacts/${appId}/public/data/general_items/${id}`;

            function showToast(message, isError = false) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 z-50 ${isError ? 'bg-red-600' : 'bg-gray-800'}`;
                toast.classList.remove('opacity-0');
                setTimeout(() => { toast.classList.add('opacity-0'); }, 3000);
            }

            function setupEventListeners() {
                addEquipmentBtn.addEventListener('click', handleAddKit);
                document.getElementById('addGeneralItemBtn').addEventListener('click', handleAddGeneralItem);
                createLoanBtn.addEventListener('click', confirmCreateLoan);
                categoryFilter.addEventListener('change', renderAvailableKitList);

                document.getElementById('toggleGeneralItemsBtn').addEventListener('click', () => {
                    document.getElementById('generalItemsWrapper').classList.toggle('hidden');
                    document.getElementById('toggleIconGeneral').classList.toggle('rotate-180');
                });

                document.getElementById('toggleAddFormBtn').addEventListener('click', () => {
                    document.getElementById('addEquipmentContainer').classList.toggle('hidden');
                    document.getElementById('toggleIconAdd').classList.toggle('rotate-180');
                });
        
                document.getElementById('toggleMaintenanceBtn').addEventListener('click', () => {
                    document.getElementById('maintenanceContainer').classList.toggle('hidden');
                    document.getElementById('toggleIconMaint').classList.toggle('rotate-180');
                });
                
                document.getElementById('toggleMissingBtn').addEventListener('click', () => {
                    document.getElementById('missingContainer').classList.toggle('hidden');
                    document.getElementById('toggleIconMiss').classList.toggle('rotate-180');
                });
        
                allModals.forEach(modal => {
                    const cancelBtn = modal.querySelector('[id$="CancelBtn"], [id$="CloseBtn"]');
                    if(cancelBtn) cancelBtn.addEventListener('click', () => closeModal(modal));
                });
        
                document.getElementById('maintenanceModalConfirmBtn').addEventListener('click', handleCompleteMaintenance);
                document.getElementById('foundModalConfirmBtn').addEventListener('click', handleMarkAsFound);
                document.getElementById('editLoanConfirmBtn').addEventListener('click', handleEditLoan);
                document.getElementById('preLoanChecklistConfirmBtn').addEventListener('click', handlePreLoanChecklistConfirm);

                
                document.getElementById('directActionConfirmBtn').addEventListener('click', async (e) => {
                    const notes = document.getElementById('directActionNotes').value.trim();
                    if (!notes) return showToast("Please provide a reason.", true);
                    
                    const isMaint = e.target.textContent.toLowerCase().includes('maintenance');
                    const newStatus = isMaint ? 'under_maintenance' : 'missing';
        
                    await updateItemStatus(activeModal.kit, newStatus, notes, activeModal.itemName);
                    closeModal(document.getElementById('directActionModal'));
                    closeModal(document.getElementById('accessoryManagementModal'));
                });
                
                document.getElementById('deleteItemBtn').addEventListener('click', () => {
                    const kit = activeModal.kit;
                    if (!kit) return;
                    document.getElementById('deleteConfirmCode').textContent = kit.code;
                    const confirmInput = document.getElementById('deleteConfirmInput');
                    const confirmBtn = document.getElementById('deleteConfirmFinalBtn');
                    confirmInput.value = '';
                    confirmBtn.disabled = true;
                    confirmInput.oninput = () => { confirmBtn.disabled = confirmInput.value !== kit.code; };
                    document.getElementById('deleteConfirmModal').style.display = 'flex';
                });

                document.getElementById('deleteConfirmFinalBtn').addEventListener('click', async () => {
                    const kit = activeModal.kit;
                    try {
                        const batch = writeBatch(db);
                        batch.delete(doc(db, equipmentDocPath(kit.id)));
                        const q = query(collection(db, historyCollectionPath), where("kitIds", "array-contains", kit.id));
                        const historySnapshot = await getDocs(q);
                        historySnapshot.forEach(historyDoc => batch.delete(historyDoc.ref));
                        await batch.commit();
                        showToast(`Successfully deleted ${kit.name} and all its history.`);
                        closeModal(document.getElementById('deleteConfirmModal'));
                        closeModal(document.getElementById('historyModal'));
                    } catch(error) { showToast(`Failed to delete ${kit.name}.`, true); }
                });

                // --- General Item Delete Modal Listeners ---
                document.getElementById('generalItemDeleteCancelBtn').addEventListener('click', () => closeModal(document.getElementById('generalItemDeleteConfirmModal')));
                document.getElementById('generalItemDeleteConfirmBtn').addEventListener('click', handleDeleteGeneralItem);

                document.getElementById('bulkMoveBtn').addEventListener('click', () => {
                    document.getElementById('bulkMoveModalTitle').textContent = `Bulk Move ${selectedItems.size} Kits`;
                    document.getElementById('bulkMoveModal').style.display = 'flex';
                });
                document.getElementById('bulkMoveConfirmBtn').addEventListener('click', handleBulkMove);
            }
        
            async function initialize() {
                // Check if firebaseConfig is populated.
                if (!firebaseConfig.apiKey) {
                    showToast("Firebase configuration is missing. Cannot connect to the database.", true);
                    console.error("Firebase config is empty. Please ensure __firebase_config is provided.");
                    return;
                }
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    onAuthStateChanged(auth, user => { 
                        if (user) {
                            console.log("Firebase Auth state changed. User is signed in:", user.uid);
                            setupFirebaseListeners(); 
                        }
                    });

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    document.getElementById('loanDate').valueAsDate = new Date();
                    setupEventListeners(); // Setup listeners after firebase is ready
                } catch (error) { 
                    console.error("Initialization Error:", error);
                    showToast("Error connecting to the database.", true);
                }
            }
        
            function setupFirebaseListeners() {
                if (!auth.currentUser) return;
                onSnapshot(collection(db, equipmentCollectionPath), snap => {
                    allEquipmentMasterList = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    populateCategoryFilter();
                    renderAllLists();
                }, (error) => {
                    console.error("Error listening to equipment collection:", error);
                    showToast("Error fetching equipment data.", true);
                });
                onSnapshot(collection(db, loansCollectionPath), snap => {
                    renderOnLoanList(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (error) => {
                    console.error("Error listening to loans collection:", error);
                    showToast("Error fetching loan data.", true);
                });
                onSnapshot(collection(db, generalItemsCollectionPath), snap => {
                    renderGeneralItemsList(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (error) => {
                    console.error("Error listening to general items collection:", error);
                    showToast("Error fetching general items.", true);
                });
            }
            
            function populateCategoryFilter() {
                const categoryFilter = document.getElementById('categoryFilter');
                const categories = [...new Set(allEquipmentMasterList.map(item => item.category).filter(Boolean))];
                const currentSelection = categoryFilter.value;
                categoryFilter.innerHTML = '<option selected>All Categories</option>';
                categories.sort().forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categoryFilter.appendChild(option);
                });
                categoryFilter.value = currentSelection;
            }
    
            function renderAllLists() {
                renderAvailableKitList();
                renderMaintenanceList();
                renderMissingList();
            }
    
            function renderList(elementId, items, emptyText, itemRenderer) {
                const element = document.getElementById(elementId);
                element.innerHTML = items.length === 0 ? `<p class="text-gray-500 p-4">${emptyText}</p>` : '';
                items.forEach(item => itemRenderer(element, item));
            }
    
            function renderAvailableKitList() {
                const categoryFilter = document.getElementById('categoryFilter');
                const selectedCategory = categoryFilter.value;
                const filteredKits = selectedCategory === 'All Categories'
                    ? allEquipmentMasterList.filter(kit => kit.status === 'available')
                    : allEquipmentMasterList.filter(kit => kit.status === 'available' && kit.category === selectedCategory);
        
                renderList('availableEquipmentList', filteredKits, 'No available kits in this category.', (el, kit) => {
                    const isSelected = selectedItems.has(kit.id);
                    const itemsNeedingAttention = (kit.items || []).filter(i => i.status !== 'available').length > 0;
                    const unavailable = itemsNeedingAttention;
                    
                    const maintWarning = unavailable ? `<p class="text-xs font-semibold text-red-600">Unavailable for Loan (Maintenance Required)</p>` : '';
                    const categoryTag = kit.category ? `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-200">${kit.category}</span>` : '';
                    
                    const div = document.createElement('div');
                    div.className = `p-2 rounded-lg ${isSelected ? 'bg-indigo-100' : 'hover:bg-gray-100'} ${unavailable ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`;
                    
                    div.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center flex-grow pr-2">
                                <input type="checkbox" class="select-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-3" data-id="${kit.id}" ${isSelected ? 'checked' : ''} ${unavailable ? 'disabled' : ''}>
                                <div>
                                    <div class="flex items-center space-x-2">
                                        <p class="font-medium text-gray-800">${kit.name}</p>
                                        ${categoryTag}
                                    </div>
                                    <p class="text-xs text-gray-500">${kit.code}</p>
                                    <p class="text-xs text-gray-500 kit-location-text ${!unavailable ? 'cursor-pointer hover:text-indigo-600' : ''}" data-kit-id="${kit.id}">
                                        Location: ${kit.location || 'Not set'}
                                    </p>
                                    ${maintWarning}
                                </div>
                            </div>
                            <div class="flex flex-col space-y-1">
                                <button class="manage-btn text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold py-1 px-2 rounded-md">Manage</button>
                                <button class="history-btn text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-2 rounded-md">History</button>
                            </div>
                        </div>`;
                    
                    if (!unavailable) {
                        const checkbox = div.querySelector('.select-checkbox');
                        div.addEventListener('click', (e) => {
                            if (e.target.tagName !== 'BUTTON' && !e.target.closest('button')) {
                                handleSelection(kit);
                            }
                        });
                        checkbox.addEventListener('click', (e) => {
                            e.stopPropagation(); 
                            handleSelection(kit);
                        });
                        div.querySelector('.kit-location-text').addEventListener('click', (e) => {
                            e.stopPropagation();
                            makeKitLocationEditable(e.target, kit.id, kit.location || '');
                        });
                    }
    
                    div.querySelector('.history-btn').addEventListener('click', (e) => { e.stopPropagation(); openHistoryModal(kit.id, kit.name, kit.status, kit.code); });
                    div.querySelector('.manage-btn').addEventListener('click', (e) => { e.stopPropagation(); openKitManagementModal(kit); });
                    el.appendChild(div);
                });
                updateBulkActionsVisibility();
            }

            function renderGeneralItemsList(items) {
                items.sort((a,b) => a.name.localeCompare(b.name));
                renderList('generalItemsList', items, 'No general items in inventory.', (el, item) => {
                    const div = document.createElement('div');
                    div.className = 'p-3 rounded-lg bg-gray-50 border flex items-center justify-between';
                    div.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-900">${item.name}</p>
                            <p class="text-xs text-gray-500">In Stock: <span class="font-bold text-lg">${item.quantity}</span></p>
                            <p class="text-xs text-gray-500">Category: ${item.category || 'N/A'}</p>
                            <p class="text-xs text-gray-500 general-item-location-text cursor-pointer hover:text-indigo-600" data-item-id="${item.id}">Location: ${item.location || 'N/A'}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button data-id="${item.id}" class="general-item-decrement text-white bg-red-500 hover:bg-red-600 rounded-full w-8 h-8 font-bold text-xl flex items-center justify-center">-</button>
                            <button data-id="${item.id}" class="general-item-increment text-white bg-green-500 hover:bg-green-600 rounded-full w-8 h-8 font-bold text-xl flex items-center justify-center">+</button>
                             <button data-item-id="${item.id}" data-item-name="${item.name}" class="general-item-delete text-gray-400 hover:text-red-500 font-bold text-2xl ml-2">&times;</button>
                        </div>
                    `;
                    el.appendChild(div);

                    div.querySelector('.general-item-increment').addEventListener('click', () => {
                        updateDoc(doc(db, generalItemDocPath(item.id)), { quantity: increment(1) });
                    });
                    div.querySelector('.general-item-decrement').addEventListener('click', () => {
                        if (item.quantity > 0) {
                           updateDoc(doc(db, generalItemDocPath(item.id)), { quantity: increment(-1) });
                        }
                    });
                    div.querySelector('.general-item-delete').addEventListener('click', (e) => {
                        const itemId = e.currentTarget.dataset.itemId;
                        const itemName = e.currentTarget.dataset.itemName;
                        activeModal.kit = { id: itemId, name: itemName }; // Use activeModal to pass data

                        const modal = document.getElementById('generalItemDeleteConfirmModal');
                        document.getElementById('generalItemDeleteConfirmText').textContent = `Are you sure you want to delete all "${itemName}" items from the inventory? This action cannot be undone.`;
                        modal.style.display = 'flex';
                    });
                    div.querySelector('.general-item-location-text').addEventListener('click', (e) => {
                        e.stopPropagation();
                        makeGeneralItemLocationEditable(e.currentTarget, item.id, item.location || '');
                    });
                });
            }
    
            function updateBulkActionsVisibility() {
                const bulkSelectCount = document.getElementById('bulkSelectCount');
                const bulkActionsContainer = document.getElementById('bulkActions');
                if(selectedItems.size > 0) {
                    bulkActionsContainer.classList.remove('hidden');
                    bulkSelectCount.textContent = `${selectedItems.size} selected`;
                } else {
                    bulkActionsContainer.classList.add('hidden');
                    bulkSelectCount.textContent = '';
                }
            }
            
            async function makeKitLocationEditable(pElement, kitId, currentLocation) {
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentLocation;
                input.className = 'w-full text-xs p-1 border border-indigo-300 rounded-md';
                
                pElement.replaceWith(input);
                input.focus();
    
                const saveLocation = async () => {
                    const newLocation = input.value.trim();
                    if (newLocation === currentLocation) {
                        renderAvailableKitList(); 
                        return;
                    }
                    
                    try {
                        const batch = writeBatch(db);
                        const kitDocRef = doc(db, equipmentDocPath(kitId));
                        const kit = allEquipmentMasterList.find(i => i.id === kitId);
    
                        batch.update(kitDocRef, { location: newLocation });
    
                        const historyNote = `Location changed from "${currentLocation || 'Not set'}" to "${newLocation}".`;
                        batch.set(doc(collection(db, historyCollectionPath)), {
                            type: 'location_change',
                            kitId: kitId,
                            kitName: kit.name,
                            notes: historyNote,
                            timestamp: serverTimestamp()
                        });
    
                        await batch.commit();
                        showToast("Kit location updated.");
                    } catch (error) {
                        showToast("Failed to update kit location.", true);
                    }
                };
    
                input.addEventListener('blur', saveLocation);
                input.addEventListener('keydown', (e) => { if (e.key === 'Enter') input.blur(); });
            }

            async function makeGeneralItemLocationEditable(pElement, itemId, currentLocation) {
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentLocation;
                input.className = 'w-full text-xs p-1 border border-indigo-300 rounded-md';
                
                pElement.replaceWith(input);
                input.focus();

                const saveLocation = async () => {
                    const newLocation = input.value.trim();
                    if (newLocation === currentLocation) {
                        const newP = pElement.cloneNode(true);
                        newP.textContent = `Location: ${currentLocation || 'Not set'}`;
                        input.replaceWith(newP);
                        return;
                    }
                    
                    try {
                        const itemDocRef = doc(db, generalItemDocPath(itemId));
                        await updateDoc(itemDocRef, { location: newLocation });
                        showToast("General item location updated.");
                    } catch (error) {
                        console.error("Failed to update general item location:", error);
                        showToast("Failed to update location.", true);
                    }
                };

                input.addEventListener('blur', saveLocation);
                input.addEventListener('keydown', (e) => { 
                    if (e.key === 'Enter') {
                        input.blur();
                    } else if (e.key === 'Escape') {
                        input.value = currentLocation;
                        input.blur();
                    }
                });
            }
            
            function renderMaintenanceList() {
                const itemsInMaintenance = [];
                allEquipmentMasterList.forEach(kit => {
                    (kit.items || []).forEach(item => {
                        if (item.status === 'under_maintenance') {
                            itemsInMaintenance.push({ ...kit, itemName: item.name });
                        }
                    });
                });
        
                renderList('maintenanceList', itemsInMaintenance, 'No items are under maintenance.', (el, item) => {
                    const div = document.createElement('div');
                    div.className = 'p-2 rounded-lg bg-orange-50 flex items-center justify-between';
                    const itemName = `${item.itemName} <span class="text-gray-500">from ${item.name}</span>`;
                    div.innerHTML = `<div><p class="font-medium text-gray-800">${itemName}</p></div><button class="log-maintenance-btn text-xs bg-orange-500 hover:bg-orange-600 text-white font-semibold py-1 px-2 rounded-md">Log Maint.</button>`;
                    div.querySelector('.log-maintenance-btn').addEventListener('click', () => openMaintenanceModal(item));
                    el.appendChild(div);
                });
            }
            
            function renderMissingList() {
                const itemsMissing = [];
                allEquipmentMasterList.forEach(kit => {
                    (kit.items || []).forEach(item => {
                        if (item.status === 'missing') {
                            itemsMissing.push({ ...kit, itemName: item.name });
                        }
                    });
                });
        
                renderList('missingList', itemsMissing, 'No items are missing.', (el, item) => {
                    const div = document.createElement('div');
                    div.className = 'p-2 rounded-lg bg-red-50 flex items-center justify-between';
                    const itemName = `${item.itemName} <span class="text-gray-500">from ${item.name}</span>`;
                    div.innerHTML = `<div><p class="font-medium text-gray-800">${itemName}</p></div><button class="mark-found-btn text-xs bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-2 rounded-md">Found</button>`;
                    div.querySelector('.mark-found-btn').addEventListener('click', () => openFoundModal(item));
                    el.appendChild(div);
                });
            }
    
            function renderOnLoanList(loans) {
                loans.sort((a, b) => new Date(a.loanDate) - new Date(b.loanDate));
                renderList('onLoanList', loans, 'No kits are currently on loan.', (el, loan) => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200 animate-fade-in';
                    const equipmentHtml = loan.kits.map(k => `<span class="inline-block bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 mr-2 mb-2">${k.name} (${k.code})</span>`).join('');
                    card.innerHTML = `<div class="flex justify-between items-start"><div><p class="font-bold text-lg">Loan ID: ${loan.loanId}</p></div><button data-loan-id="${loan.id}" class="manage-loan-btn bg-blue-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-blue-600 transition-colors text-sm">Manage Loan</button></div><div class="mt-4"><p class="text-sm"><span class="font-semibold">Loaned:</span> ${loan.loanDate}</p><p class="text-sm"><span class="font-semibold">Due:</span> ${loan.dueDate}</p></div><div class="mt-4 pt-4 border-t"><h4 class="font-semibold mb-2">Kits:</h4><div class="flex flex-wrap">${equipmentHtml}</div></div>`;
                    card.querySelector('.manage-loan-btn').addEventListener('click', (e) => {
                        const foundLoan = loans.find(l => l.id === e.target.dataset.loanId);
                        if (foundLoan) openEditLoanModal(foundLoan);
                    });
                    el.appendChild(card);
                });
            }
            
            function renderSelectedForLoan() {
                document.getElementById('createLoanBtn').disabled = selectedItems.size === 0;
                renderList('selectedForLoanList', Array.from(selectedItems.values()), 'No kits selected.', (el, itemData) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex items-center justify-between bg-indigo-50 p-2 rounded-md mb-2';
                    itemDiv.innerHTML = `
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                            <span>${itemData.kit.name} (${itemData.kit.code}) - Checklist Complete</span>
                        </div>
                        <button data-id="${itemData.kit.id}" class="remove-selection-btn text-red-500 hover:text-red-700 font-bold">&times;</button>
                    `;
                    itemDiv.querySelector('.remove-selection-btn').addEventListener('click', (e) => {
                        const kitId = e.currentTarget.dataset.id;
                        selectedItems.delete(kitId);
                        renderSelectedForLoan();
                        renderAvailableKitList();
                    });
                    el.appendChild(itemDiv);
                });
            }
    
            function handleSelection(kit) {
                if (selectedItems.has(kit.id)) {
                    selectedItems.delete(kit.id);
                    renderAvailableKitList();
                    renderSelectedForLoan();
                } else {
                    openPreLoanChecklistModal(kit);
                }
            }

            async function handleAddGeneralItem() {
                const name = document.getElementById('generalItemName').value.trim();
                const category = document.getElementById('generalItemCategory').value.trim();
                const quantity = parseInt(document.getElementById('generalItemQuantity').value, 10);
                const location = document.getElementById('generalItemLocation').value.trim();

                if (!name || !category || !quantity || quantity < 1) {
                    showToast("Name, Category, and a valid Quantity are required.", true);
                    return;
                }

                try {
                    const q = query(collection(db, generalItemsCollectionPath), where("name", "==", name), where("category", "==", category));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        const existingDoc = querySnapshot.docs[0];
                        await updateDoc(doc(db, generalItemDocPath(existingDoc.id)), { 
                            quantity: increment(quantity) 
                        });
                        showToast(`Added ${quantity} to ${name} inventory.`);
                    } else {
                        await addDoc(collection(db, generalItemsCollectionPath), { name, category, quantity, location });
                        showToast(`Added new item: ${name}.`);
                    }

                    document.getElementById('generalItemName').value = '';
                    document.getElementById('generalItemCategory').value = '';
                    document.getElementById('generalItemQuantity').value = '1';
                    document.getElementById('generalItemLocation').value = '';
                } catch (error) {
                    console.error("Error adding general item:", error);
                    showToast("Failed to add general item.", true);
                }
            }
            
            async function handleDeleteGeneralItem() {
                const itemId = activeModal.kit.id;
                const itemName = activeModal.kit.name;
                if (!itemId) return;

                try {
                    await deleteDoc(doc(db, generalItemDocPath(itemId)));
                    showToast(`Deleted ${itemName} from inventory.`);
                } catch(error) {
                    showToast(`Failed to delete ${itemName}.`, true);
                    console.error("Error deleting general item:", error);
                } finally {
                    closeModal(document.getElementById('generalItemDeleteConfirmModal'));
                }
            }

            async function handleAddKit() {
                const name = document.getElementById('kitName').value.trim();
                const code = document.getElementById('kitCode').value.trim();
                let category = document.getElementById('kitCategory').value.trim();
                const itemsStr = document.getElementById('kitItems').value.trim();
                const location = document.getElementById('kitLocation').value.trim();
                if (!name || !code || !category) return showToast("Kit Name, Code, and Category are required.", true);
        
                if(category) {
                    category = category.charAt(0).toUpperCase() + category.slice(1).toLowerCase();
                }
        
                const items = itemsStr ? itemsStr.split(',').map(s => ({ name: s.trim(), status: 'available' })).filter(a => a.name) : [];
                try {
                    await addDoc(collection(db, equipmentCollectionPath), { name, code, category, items, status: 'available', location, timestamp: serverTimestamp() });
                    showToast("Kit added successfully!");
                    ['kitName', 'kitCode', 'kitCategory', 'kitItems', 'kitLocation'].forEach(id => document.getElementById(id).value = '');
                } catch (error) { showToast("Failed to add kit.", true); }
            }
            
            async function confirmCreateLoan() {
                const loanId = document.getElementById('uniqueLoanId').value.trim();
                if(!loanId) return showToast("Unique Loan ID is required.", true);
                
                const kitsForLoan = [];
                selectedItems.forEach((value, key) => {
                    kitsForLoan.push({
                        ...value.kit,
                        preLoanChecklist: value.checklistData
                    });
                });

                try {
                    const batch = writeBatch(db);
                    batch.set(doc(collection(db, loansCollectionPath)), {
                        loanId: loanId,
                        loanDate: document.getElementById('loanDate').value, 
                        dueDate: document.getElementById('dueDate').value, 
                        kits: kitsForLoan, 
                        kitIds: kitsForLoan.map(e => e.id),
                        timestamp: serverTimestamp()
                    });
                    kitsForLoan.forEach(kit => batch.update(doc(db, equipmentDocPath(kit.id)), { status: 'on_loan' }));
                    await batch.commit();
                    ['uniqueLoanId', 'dueDate'].forEach(id => document.getElementById(id).value = '');
                    selectedItems.clear();
                    renderSelectedForLoan();
                    renderAvailableKitList();
                    showToast("Loan created successfully!");
                } catch (error) { showToast("Failed to create loan.", true); }
            }
            
            function openEditLoanModal(loan) {
                activeModal.loan = loan;
                document.getElementById('editLoanModalTitle').textContent = `Edit Loan: ${loan.loanId}`;
                document.getElementById('editLoanNotes').value = '';
        
                const currentItemsContainer = document.getElementById('editLoanCurrentItems');
                currentItemsContainer.innerHTML = ''; // Clear previous content
                loan.kits.forEach(kit => {
                    const itemWrapper = document.createElement('div');
                    itemWrapper.id = `wrapper-${kit.id}`;
                    itemWrapper.className = 'p-2 bg-gray-100 rounded-md';

                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex items-center justify-between';
                    itemDiv.innerHTML = `
                        <span>${kit.name} (${kit.code})</span>
                        <select class="return-action-select text-sm rounded-md border-gray-300" data-kit-id="${kit.id}">
                            <option value="keep">Keep on Loan</option>
                            <option value="return">Return Kit</option>
                        </select>
                    `;
                    
                    itemWrapper.appendChild(itemDiv);
                    currentItemsContainer.appendChild(itemWrapper);
                });

                // Add event listeners after elements are in the DOM
                currentItemsContainer.querySelectorAll('.return-action-select').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const kitId = e.target.dataset.kitId;
                        const wrapper = document.getElementById(`wrapper-${kitId}`);
                        const existingChecklist = document.getElementById(`checklist-${kitId}`);
                        if(existingChecklist) existingChecklist.remove();

                        if (e.target.value === 'return') {
                            const checklistDiv = document.createElement('div');
                            checklistDiv.id = `checklist-${kitId}`;
                            checklistDiv.className = 'mt-3 pt-3 border-t border-gray-300 space-y-2';
                            checklistDiv.innerHTML = `
                                <h4 class="font-semibold text-sm">Return Checklist for ${loan.kits.find(k=>k.id===kitId).name}</h4>
                                <div class="flex items-center justify-between">
                                    <label class="text-sm">Condition good?</label>
                                    <div>
                                        <input type="radio" name="condition-${kitId}" value="Yes" checked class="mr-1"><label class="mr-2 text-sm">Yes</label>
                                        <input type="radio" name="condition-${kitId}" value="No" class="mr-1"><label class="text-sm">No</label>
                                    </div>
                                </div>
                                 <div class="flex items-center justify-between">
                                    <label class="text-sm">All accessories returned?</label>
                                    <div>
                                        <input type="radio" name="accessories-${kitId}" value="Yes" checked class="mr-1"><label class="mr-2 text-sm">Yes</label>
                                        <input type="radio" name="accessories-${kitId}" value="No" class="mr-1"><label class="text-sm">No</label>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium">Return Notes</label>
                                    <textarea class="return-notes w-full p-1 border border-gray-300 rounded-md text-sm" rows="2" placeholder="e.g., Minor scratch on body."></textarea>
                                </div>
                            `;
                            wrapper.appendChild(checklistDiv);
                        }
                    });
                });
        
                // Render addable kits
                const addableKits = allEquipmentMasterList.filter(kit => kit.status === 'available');
                 renderList('editLoanAddableItems', addableKits, 'No other kits available to add.', (el, kit) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-2 hover:bg-gray-100 rounded-md';
                    div.innerHTML = `<span>${kit.name} (${kit.code})</span><button class="add-to-loan-btn text-xs bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-2 rounded-md" data-kit-id="${kit.id}">Add</button>`;
                    div.querySelector('.add-to-loan-btn').addEventListener('click', function() {
                        this.disabled = true;
                        this.textContent = 'Added';
                        this.classList.add('bg-gray-400', 'cursor-not-allowed');
                        this.dataset.added = 'true';
                    });
                    el.appendChild(div);
                });
        
                document.getElementById('editLoanModal').style.display = 'flex';
            }
    
            async function handleEditLoan() {
                const loan = activeModal.loan;
                const generalNotes = document.getElementById('editLoanNotes').value.trim();
                const batch = writeBatch(db);

                const kitsToKeep = [...loan.kits];
                document.querySelectorAll('#editLoanCurrentItems .return-action-select').forEach(select => {
                    if (select.value === 'return') {
                        const kitId = select.dataset.kitId;
                        const kit = loan.kits.find(k => k.id === kitId);
                        
                        batch.update(doc(db, equipmentDocPath(kit.id)), { status: 'available' });

                        const checklistDiv = document.getElementById(`checklist-${kitId}`);
                        const checklistData = {
                            conditionGood: checklistDiv.querySelector('input[name="condition-' + kitId + '"]:checked').value,
                            accessoriesReturned: checklistDiv.querySelector('input[name="accessories-' + kitId + '"]:checked').value,
                            notes: checklistDiv.querySelector('.return-notes').value.trim()
                        };
                        
                        batch.set(doc(collection(db, historyCollectionPath)), {
                            type: 'return',
                            loanId: loan.loanId,
                            kitId: kit.id,
                            kitName: kit.name,
                            checklist: checklistData,
                            timestamp: serverTimestamp()
                        });

                        const index = kitsToKeep.findIndex(k => k.id === kitId);
                        if(index > -1) kitsToKeep.splice(index, 1);
                    }
                });

                const kitsToAdd = [];
                document.querySelectorAll('#editLoanAddableItems .add-to-loan-btn[data-added="true"]').forEach(btn => {
                    const kit = allEquipmentMasterList.find(i => i.id === btn.dataset.kitId);
                    if(kit) {
                        kitsToAdd.push(kit);
                        batch.update(doc(db, equipmentDocPath(kit.id)), { status: 'on_loan' });
                        batch.set(doc(collection(db, historyCollectionPath)), {
                            type: 'add_to_loan',
                            loanId: loan.loanId,
                            kitId: kit.id,
                            kitName: kit.name,
                            notes: generalNotes,
                            timestamp: serverTimestamp()
                        });
                    }
                });
                
                const finalKitList = [...kitsToKeep, ...kitsToAdd];
                if (finalKitList.length === 0) {
                    batch.delete(doc(db, loanDocPath(loan.id)));
                } else {
                    batch.update(doc(db, loanDocPath(loan.id)), {
                        kits: finalKitList,
                        kitIds: finalKitList.map(k => k.id),
                    });
                }

                try {
                    await batch.commit();
                    showToast("Loan updated successfully!");
                    closeModal(document.getElementById('editLoanModal'));
                } catch (error) {
                    console.error("Failed to edit loan:", error);
                    showToast("Failed to update loan.", true);
                }
            }
            
            async function updateItemStatus(kit, newStatus, notes, itemName = null) {
                 try {
                    const batch = writeBatch(db);
                    const kitDocRef = doc(db, equipmentDocPath(kit.id));
                    const historyNote = `STATUS CHANGE on ${itemName || kit.name} to ${newStatus.replace('_', ' ')}: ${notes}`;
                    
                    batch.set(doc(collection(db, historyCollectionPath)), { type: 'status_change', kitId: kit.id, kitName: kit.name, notes: historyNote, timestamp: serverTimestamp() });
    
                    if (itemName) {
                        const fullKitDoc = allEquipmentMasterList.find(i => i.id === kit.id);
                        const updatedItems = fullKitDoc.items.map(i => i.name === itemName ? { ...i, status: newStatus } : i);
                        batch.update(kitDocRef, { items: updatedItems });
                    } else {
                        batch.update(kitDocRef, { status: newStatus });
                    }
    
                    await batch.commit();
                    showToast(`${itemName || kit.name} flagged as ${newStatus.replace('_', ' ')}.`);
                } catch (error) {
                    showToast("Failed to update status.", true);
                }
            }
    
            function openDirectActionModal(kit, mode, itemName = null) {
                activeModal.kit = kit;
                activeModal.itemName = itemName;
                
                const modal = document.getElementById('directActionModal');
                const title = modal.querySelector('#directActionModalTitle');
                const confirmBtn = modal.querySelector('#directActionConfirmBtn');
                const targetName = itemName || kit.name;
    
                if (mode === 'maintenance') {
                    title.textContent = `Flag ${targetName} for Maintenance`;
                    confirmBtn.className = 'bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-700';
                    confirmBtn.textContent = 'Flag for Maintenance';
                } else { // Missing
                    title.textContent = `Flag ${targetName} as Missing`;
                    confirmBtn.className = 'bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700';
                    confirmBtn.textContent = 'Flag as Missing';
                }
                document.getElementById('directActionNotes').value = '';
                modal.style.display = 'flex';
            }
    
            function openKitManagementModal(kit) {
                activeModal.kit = kit;
                const listEl = document.getElementById('accessoryManagementList');
                document.getElementById('accessoryManagementTitle').textContent = `Manage: ${kit.name}`;
                listEl.innerHTML = '';
        
                (kit.items || []).forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'p-2 flex items-center justify-between border-t';
                    itemDiv.innerHTML = `
                        <span>${item.name} - <span class="capitalize font-medium">${item.status.replace('_', ' ')}</span></span>
                        <div class="flex space-x-1">
                            <button class="item-maint-btn text-xs bg-orange-100 hover:bg-orange-200 text-orange-700 font-semibold py-1 px-2 rounded-md">Maint</button>
                            <button class="item-miss-btn text-xs bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-1 px-2 rounded-md">Miss</button>
                        </div>`;
                    itemDiv.querySelector('.item-maint-btn').addEventListener('click', () => openDirectActionModal(kit, 'maintenance', item.name));
                    itemDiv.querySelector('.item-miss-btn').addEventListener('click', () => openDirectActionModal(kit, 'missing', item.name));
                    listEl.appendChild(itemDiv);
                });
        
                document.getElementById('accessoryManagementModal').style.display = 'flex';
            }
            
            function openMaintenanceModal(item) {
                activeModal.kit = item;
                document.getElementById('maintenanceModalTitle').textContent = `Log Maintenance for ${item.itemName}`;
                document.getElementById('maintenanceNotes').value = '';
                document.getElementById('maintenanceModal').style.display = 'flex';
            }
    
            async function handleCompleteMaintenance() {
                const notes = document.getElementById('maintenanceNotes').value.trim();
                const item = activeModal.kit;
                if (!notes || !item) return showToast("Please enter maintenance notes.", true);
        
                try {
                    const batch = writeBatch(db);
                    const kitDocRef = doc(db, equipmentDocPath(item.id));
                    const historyNote = `Maintenance on: ${item.itemName}. Action: ${notes}`;
                    
                    batch.set(doc(collection(db, historyCollectionPath)), { type: 'maintenance', kitId: item.id, kitName: item.name, notes: historyNote, timestamp: serverTimestamp() });
                    
                    const fullKitDoc = allEquipmentMasterList.find(i => i.id === item.id);
                    const updatedItems = fullKitDoc.items.map(i => i.name === item.itemName ? { ...i, status: 'available' } : i);
                    batch.update(kitDocRef, { items: updatedItems });
                    
                    await batch.commit();
                    showToast(`Maintenance logged for ${item.itemName}.`);
                    closeModal(document.getElementById('maintenanceModal'));
                } catch(error) { showToast("Failed to log maintenance.", true); }
            }
    
            function openFoundModal(item) {
                activeModal.kit = item;
                document.getElementById('foundModalTitle').textContent = `Mark ${item.itemName} as Found`;
                document.getElementById('foundNotes').value = '';
                document.getElementById('foundModal').style.display = 'flex';
            }
    
            async function handleMarkAsFound() {
                const notes = document.getElementById('foundNotes').value.trim();
                const item = activeModal.kit;
                if (!item) return;
        
                 try {
                    const batch = writeBatch(db);
                    const kitDocRef = doc(db, equipmentDocPath(item.id));
                    const historyNote = `FOUND: ${item.itemName}. Notes: ${notes}`;
                    
                    batch.set(doc(collection(db, historyCollectionPath)), { type: 'status_change', kitId: item.id, kitName: item.name, notes: historyNote, timestamp: serverTimestamp() });
                    
                    const fullKitDoc = allEquipmentMasterList.find(i => i.id === item.id);
                    const updatedItems = fullKitDoc.items.map(i => i.name === item.itemName ? { ...i, status: 'available' } : i);
                    batch.update(kitDocRef, { items: updatedItems });
    
                    await batch.commit();
                    showToast(`Item marked as found.`);
                    closeModal(document.getElementById('foundModal'));
    
                } catch(error) { showToast("Failed to update item status.", true); }
            }
            
            async function handleBulkMove() {
                const newLocation = document.getElementById('bulkMoveLocation').value.trim();
                if (!newLocation) {
                    showToast('Please enter a new location.', true);
                    return;
                }
        
                try {
                    const batch = writeBatch(db);
                    for(const kitId of selectedItems.keys()) {
                        const kit = allEquipmentMasterList.find(i => i.id === kitId);
                        if(!kit) continue;
                        
                        const kitDocRef = doc(db, equipmentDocPath(kitId));
                        batch.update(kitDocRef, { location: newLocation });
    
                        const historyNote = `Bulk moved from "${kit.location || 'Not set'}" to "${newLocation}".`;
                        batch.set(doc(collection(db, historyCollectionPath)), {
                            type: 'location_change',
                            kitIds: [kitId],
                            kitName: kit.name,
                            notes: historyNote,
                            timestamp: serverTimestamp()
                        });
                    }
                    await batch.commit();
                    showToast(`${selectedItems.size} kits moved successfully.`);
                    selectedItems.clear();
                    closeModal(document.getElementById('bulkMoveModal'));
                    renderAvailableKitList();
                    renderSelectedForLoan();
                } catch (error) {
                    console.error('Bulk move failed:', error);
                    showToast('Failed to move items.', true);
                }
            }

            function openPreLoanChecklistModal(kit) {
                activeModal.kit = kit;
                const modal = document.getElementById('preLoanChecklistModal');
                document.getElementById('preLoanChecklistTitle').textContent = `Pre-Loan Checklist: ${kit.name}`;
                document.getElementById('preLoanChecklistForm').reset();
                modal.style.display = 'flex';
            }

            function handlePreLoanChecklistConfirm() {
                const checklistData = {
                    conditionGood: document.querySelector('input[name="preLoanCondition"]:checked').value,
                    accessoriesPresent: document.querySelector('input[name="preLoanAccessories"]:checked').value,
                    notes: document.getElementById('preLoanNotes').value.trim()
                };

                selectedItems.set(activeModal.kit.id, { kit: activeModal.kit, checklistData: checklistData });
                
                renderAvailableKitList();
                renderSelectedForLoan();
                closeModal(document.getElementById('preLoanChecklistModal'));
            }
    
            async function openHistoryModal(kitId, kitName, status, code) {
                activeModal.kit = {id: kitId, name: kitName, status: status, code: code};
                document.getElementById('historyModalTitle').textContent = `Loan History for ${kitName}`;
                document.getElementById('historyModalContent').innerHTML = '<p class="text-gray-500">Loading history...</p>';
                document.getElementById('deleteItemBtn').disabled = status === 'on_loan';
                document.getElementById('historyModal').style.display = 'flex';
        
                const loanQuery = getDocs(collection(db, loansCollectionPath));
                const historyQuery = getDocs(collection(db, historyCollectionPath));

                const [loanSnapshot, historySnapshot] = await Promise.all([loanQuery, historyQuery]);
                
                let combinedHistory = [];

                loanSnapshot.forEach(doc => {
                    const loanData = doc.data();
                    if (loanData.kitIds && loanData.kitIds.includes(kitId)) {
                        const kitInLoan = loanData.kits.find(k => k.id === kitId);
                        if (kitInLoan && kitInLoan.preLoanChecklist) {
                             combinedHistory.push({
                                type: 'loan_creation',
                                loanId: loanData.loanId,
                                timestamp: loanData.timestamp,
                                checklist: kitInLoan.preLoanChecklist
                            });
                        }
                    }
                });

                historySnapshot.forEach(doc => {
                    const historyData = doc.data();
                    if (historyData.kitId === kitId || (historyData.kitIds && historyData.kitIds.includes(kitId))) {
                        combinedHistory.push(historyData);
                    }
                });

                const contentDiv = document.getElementById('historyModalContent');
                if (combinedHistory.length === 0) {
                    contentDiv.innerHTML = '<p class="text-gray-500">No history found for this item.</p>';
                    return;
                }

                contentDiv.innerHTML = '';
                combinedHistory.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);

                combinedHistory.forEach(record => {
                    const card = document.createElement('div');
                    const date = record.timestamp ? record.timestamp.toDate().toLocaleDateString() : 'Date not available';
                    let header = '', notes = '', bgColor = '', borderColor = '', headerColor = '';
    
                    switch (record.type) {
                        case 'return':
                            header = `Returned from Loan ${record.loanId}`;
                            const returnChecklist = record.checklist;
                            notes = `
                                <p><strong>Condition Good:</strong> ${returnChecklist.conditionGood}</p>
                                <p><strong>Accessories Returned:</strong> ${returnChecklist.accessoriesReturned}</p>
                                ${returnChecklist.notes ? `<p><strong>Notes:</strong> ${returnChecklist.notes}</p>` : ''}
                            `;
                            bgColor = 'bg-green-50'; borderColor = 'border-green-200'; headerColor = 'text-green-800';
                            break;
                        case 'loan_creation':
                             header = `Loaned out in Loan ${record.loanId}`;
                            const loanChecklist = record.checklist;
                            notes = `
                                <p><strong>Pre-Loan Condition Good:</strong> ${loanChecklist.conditionGood}</p>
                                <p><strong>Pre-Loan Accessories Present:</strong> ${loanChecklist.accessoriesPresent}</p>
                                ${loanChecklist.notes ? `<p><strong>Notes:</strong> ${loanChecklist.notes}</p>` : ''}
                            `;
                            bgColor = 'bg-gray-100'; borderColor = 'border-gray-200'; headerColor = 'text-gray-800';
                            break;
                        case 'add_to_loan':
                            header = `Added to Loan ${record.loanId}`;
                            notes = record.notes ? `<p><strong>Notes:</strong> ${record.notes}</p>` : '';
                            bgColor = 'bg-blue-50'; borderColor = 'border-blue-200'; headerColor = 'text-blue-800';
                            break;
                        case 'maintenance':
                        case 'status_change':
                        case 'location_change':
                            header = record.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); // Capitalize words
                            notes = record.notes || 'No details provided.';
                            bgColor = 'bg-yellow-50'; borderColor = 'border-yellow-200'; headerColor = 'text-yellow-800';
                            break;
                        default:
                           return;
                    }
                    
                    card.className = `${bgColor} p-4 rounded-lg border ${borderColor}`;
                    card.innerHTML = `<div class="flex justify-between items-center"><p class="font-bold ${headerColor}">${header}</p><p class="text-sm font-medium">${date}</p></div><div class="mt-2 pt-2 border-t text-sm">${notes}</div>`;
                    contentDiv.appendChild(card);
                });
            }
            
            function closeModal(modal) {
                modal.style.display = 'none';
                activeModal = { loan: null, kit: null, itemName: null, checklistData: null };
            }
    
            initialize();
        });
    </script>
</body>
</html>
